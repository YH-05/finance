name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  # 毎週月曜日の朝に定期実行
  schedule:
    - cron: '0 0 * * 1'
  # 手動実行を許可
  workflow_dispatch:

# 同じワークフローの同時実行を制御
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"  # デフォルトバージョン（lint/typecheck用）
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # 変更されたファイルを検出
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'src/**/*.py'
              - 'tests/**/*.py'
              - '.claude/**/*.py'
              - 'pyproject.toml'
              - 'uv.lock'
              - '.github/workflows/ci.yml'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # full history for better blame info

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python pin ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run pre-commit
      run: uv run pre-commit run --all-files

    - name: Check for security issues
      run: |
        uv pip install --upgrade pip
        # CVE-2026-0994: protobuf DoS vulnerability - no fix available yet (2026-01-25)
        uv run pip-audit --skip-editable --ignore-vuln CVE-2026-0994
        uv run bandit -c pyproject.toml -r src/

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python pin ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run pyright
      run: uv run pyright

  test:
    name: Unit Tests Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]
        os: [ubuntu-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python pin ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Install Playwright browsers
      run: uv run playwright install chromium --with-deps

    - name: Run unit tests (no API key required)
      env:
        PYTHONPATH: ${{ github.workspace }}/src
      run: |
        uv run pytest tests/ \
          -m "not integration" \
          --cov=src \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-report=html \
          --junit-xml=test-results.xml \
          -v

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: test-results.xml

    # オプション: カバレッジレポートのアップロード
    # - name: Upload coverage reports
    #   uses: codecov/codecov-action@v4
    #   with:
    #     file: ./coverage.xml
    #     flags: unittests
    #     name: ${{ matrix.os }}-${{ matrix.python-version }}
    #     fail_ci_if_error: false  # カバレッジサービスの問題でCIを失敗させない

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [changes, test]
    # Run integration tests only on main branch push (to control API costs)
    # and only when unit tests pass
    if: |
      (needs.changes.outputs.python == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python pin ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run integration tests
      if: env.ANTHROPIC_API_KEY != ''
      env:
        PYTHONPATH: ${{ github.workspace }}/src
      run: |
        uv run pytest tests/ \
          -m "integration" \
          --junit-xml=integration-test-results.xml \
          -v

    - name: Skip integration tests (no API key)
      if: env.ANTHROPIC_API_KEY == ''
      run: |
        echo "::warning::ANTHROPIC_API_KEY not set. Skipping integration tests."
        echo "To run integration tests, add ANTHROPIC_API_KEY to repository secrets."

    - name: Upload integration test results
      if: always() && env.ANTHROPIC_API_KEY != ''
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: integration-test-results.xml

  # オプション: パッケージのビルド
  # build:
  #   name: Build Distribution
  #   needs: [lint, type-check, test]
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Install uv
  #     uses: astral-sh/setup-uv@v3

  #   - name: Build package
  #     run: uv build

  #   - name: Check built distributions
  #     run: |
  #       uv run twine check dist/*
  #       ls -la dist/

  #   - name: Upload distributions
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: dist
  #       path: dist/

  # オプション: ドキュメントのビルド
  # docs:
  #   name: Build Documentation
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Install uv
  #     uses: astral-sh/setup-uv@v3
  #     with:
  #       enable-cache: true

  #   - name: Set up Python
  #     run: uv python pin ${{ env.PYTHON_VERSION }}

  #   - name: Install dependencies
  #     run: |
  #       uv sync --all-extras
  #       uv add sphinx sphinx-rtd-theme sphinx-autodoc-typehints

  #   - name: Build docs
  #     run: |
  #       uv run sphinx-build -b html docs/ docs/_build/html

  #   - name: Upload docs
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: docs
  #       path: docs/_build/html/

  # すべてのジョブが成功したかチェック（branch protectionで使用）
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [
      changes,
      lint,
      type-check,
      test,
      integration-test,
      # build,
      # docs
    ]
    if: always()
    steps:
      - name: Decide whether the all jobs succeeded
        uses: re-actors/alls-green@release/v1
        with:
          # integration-test is optional (only runs on main branch push)
          allowed-skips: lint, type-check, test, integration-test
          jobs: ${{ toJSON(needs) }}
