# Issue Refinement Guide

Issue ブラッシュアップの詳細ガイドです。

---

## 1. 引数解析

### パターン A: Issue 番号指定

- 形式: `123` または `123 124 125`（数値のみ、`#` は不要）
- 抽出: スペース区切りで数値を Issue 番号として取得
- 複数指定された場合は順番に処理

### パターン B: project.md パス指定

- 形式: `@src/<library_name>/docs/project.md` または `@docs/project/<slug>.md`
- 処理:
  1. project.md を読み込み
  2. `Issue: [#番号](URL)` から全 Issue 番号を抽出
  3. 抽出した全 Issue を対象にブラッシュアップ

**引数が不正な場合**:

```text
エラー: 引数の形式が正しくありません。

使用例:
- 単一 Issue: /issue-refine 123
- 複数 Issue: /issue-refine 123 124 125
- project.md: /issue-refine @src/market_analysis/docs/project.md
```

---

## 2. 改善対象の選択

AskUserQuestion ツールで改善対象を選択:

```yaml
questions:
  - question: "Issue #{number} のどの部分を改善しますか？"
    header: "改善対象"
    options:
      - label: "本文全体"
        description: "概要・詳細・受け入れ条件すべてを改善"
      - label: "受け入れ条件のみ"
        description: "測定可能で明確な条件に洗練"
      - label: "タイトルと概要"
        description: "タイトルと概要セクションを改善"
```

---

## 3. 8項目の詳細確認

Issue の不明点・曖昧な点をユーザーに確認し、改善案生成に必要な情報を収集します。

### 項目 1: 背景・目的

```yaml
question: "この機能の主な目的は何ですか？"
header: "目的"
options:
  - label: "運用効率化"
    description: "既存業務の効率化・自動化"
  - label: "新機能追加"
    description: "新しい機能の提供"
  - label: "問題解決"
    description: "既存の問題・バグの修正"
  - label: "品質改善"
    description: "パフォーマンス・保守性の向上"
```

確認ポイント:
- なぜこの機能/修正が必要か
- どのような問題を解決するか
- 誰が使うのか（ターゲットユーザー）

### 項目 2: 実装スコープ

```yaml
question: "実装のスコープはどこまでですか？"
header: "スコープ"
multiSelect: true
options:
  - label: "基本機能のみ"
    description: "最小限の機能実装"
  - label: "エラーハンドリング"
    description: "例外処理・バリデーション含む"
  - label: "テスト実装"
    description: "ユニットテスト・統合テスト含む"
  - label: "ドキュメント"
    description: "README・API ドキュメント含む"
```

確認ポイント:
- 何をやる/やらないか
- 既存機能との関係
- MVPの範囲

### 項目 3: 連携・依存関係

```yaml
question: "他の機能との連携はありますか？"
header: "連携"
multiSelect: true
options:
  - label: "単独動作"
    description: "他機能に依存しない"
  - label: "既存機能を利用"
    description: "既存のモジュール・API を使用"
  - label: "既存機能を拡張"
    description: "既存機能に機能追加"
  - label: "新規統合"
    description: "外部サービス・ライブラリと統合"
```

確認ポイント:
- 依存する Issue（depends_on）
- ブロックする Issue（blocks）
- 外部サービス連携

### 項目 4: 優先度・期限

```yaml
question: "優先度と期限について教えてください"
header: "優先度"
options:
  - label: "緊急（P0）"
    description: "今すぐ対応が必要"
  - label: "高（P1）"
    description: "1週間以内に対応"
  - label: "中（P2）"
    description: "1ヶ月以内に対応"
  - label: "低（P3）"
    description: "いつでもよい"
```

### 項目 5-8: 自由記述

以下は自由記述で具体的な情報を収集:

**項目 5: ユースケース**
- 「この機能を使う具体的なユースケースを教えてください」

**項目 6: 受け入れ条件詳細**
- 「受け入れ条件として、どのような状態になれば完了と判断しますか？」

**項目 7: 実装時の注意点**
- 「実装時に特に注意すべき点はありますか？」

**項目 8: 関連 Issue**
- 「関連する Issue や参考資料があれば教えてください」

---

## 4. 確認情報の構造化

ユーザーの回答を構造化して保存:

```json
{
  "purpose": "運用効率化",
  "scope": ["基本機能のみ", "エラーハンドリング", "テスト実装"],
  "integration": ["既存機能を利用"],
  "priority": "中（P2）",
  "use_cases": "ユーザーの自由記述",
  "acceptance_criteria_detail": "ユーザーの自由記述",
  "notes": "ユーザーの自由記述",
  "related_issues": ["#123", "#456"]
}
```

---

## 5. 改善案生成ガイドライン

### タイトル改善

| 改善前 | 改善後 |
|--------|--------|
| バグ修正 | ログイン時に 500 エラーが発生する問題を修正 |
| 機能追加 | ユーザープロフィールに SNS 連携機能を追加 |
| リファクタ | 認証モジュールを Strategy パターンでリファクタリング |

### 概要改善

| 改善前 | 改善後 |
|--------|--------|
| 処理が遅い | API レスポンスが 3 秒以上かかるケースがある |
| UIを改善したい | モバイル表示時にボタンが画面外にはみ出す |

### 受け入れ条件改善

| 改善前（曖昧） | 改善後（測定可能） |
|----------------|-------------------|
| パフォーマンスが改善される | 平均レスポンスタイムが 500ms 以下になる |
| テストが通る | `make test` が成功する |
| ドキュメントがある | README.md に使用例が記載されている |
| 使いやすい | フォーム入力が 3 ステップ以内で完了する |
| バグが直る | エラーログに該当例外が出力されない |

---

## 6. 改善案への情報反映チェックリスト

改善案生成時に以下を確認:

- [ ] ユーザー確認情報の「目的」が概要に反映されている
- [ ] 「スコープ」が詳細セクションに明記されている
- [ ] 「連携」が詳細セクションまたは関連 Issue に記載されている
- [ ] 「優先度」が備考または Issue ラベルとして設定されている
- [ ] 「ユースケース」が概要または詳細に含まれている
- [ ] 「受け入れ条件の詳細」が測定可能な受け入れ条件に変換されている
- [ ] 「実装時の注意点」が詳細または備考に記載されている
- [ ] 「関連 Issue」が備考セクションに追加されている

---

## 7. 差分表示と確認

### 差分表示形式

```markdown
## Issue #{number}: {title}

### タイトル
- **改善前**: {old_title}
- **改善後**: {new_title}

### 本文の変更

#### 概要
```diff
- [改善前の概要]
+ [改善後の概要]
```

#### 受け入れ条件
```diff
- [ ] 改善前の条件1
- [ ] 改善前の条件2
+ [ ] 改善後の条件1（測定可能）
+ [ ] 改善後の条件2（測定可能）
+ [ ] 改善後の条件3（追加）
```
```

### 確認ダイアログ

```yaml
questions:
  - question: "この改善案を Issue #{number} に適用しますか？"
    header: "適用確認"
    options:
      - label: "適用する"
        description: "改善案で Issue を更新"
      - label: "修正して適用"
        description: "改善案を編集してから適用"
      - label: "スキップ"
        description: "この Issue の更新をスキップ"
```

---

## 8. 複数 Issue 処理時の動作

複数 Issue が指定された場合:

1. 各 Issue を順番に処理
2. 各 Issue ごとに確認ダイアログを表示
3. 「すべてに同じ設定を適用」オプションを提供:

```yaml
questions:
  - question: "残り {count} 件の Issue にも同じ改善設定を適用しますか？"
    header: "一括設定"
    options:
      - label: "同じ設定で続行"
        description: "残りの Issue も同じ改善対象で処理"
      - label: "個別に設定"
        description: "各 Issue ごとに改善対象を選択"
```

---

## 9. エラーハンドリング

| ケース | 対処 |
|--------|------|
| GitHub 認証エラー | `gh auth login` を案内 |
| Issue が存在しない | エラーメッセージを表示、次の Issue へ |
| Issue 更新権限なし | 権限不足を通知 |
| 本文が空の Issue | テンプレートを適用して新規作成 |
| closed Issue | 警告を表示、続行するか確認 |

---

## 10. コマンド完了条件

- [ ] 引数が正しく解析されている
- [ ] Issue 情報が取得されている
- [ ] 改善対象が選択されている
- [ ] 8項目の詳細確認が完了している
- [ ] 改善案が生成されている（確認情報を反映）
- [ ] ユーザー確認が完了している
- [ ] 承認された Issue が更新されている
- [ ] 結果が表示されている
