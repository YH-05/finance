# エージェント設計ガイド

## エージェント設計原則

### 1. 単一責任の原則（Single Responsibility）

各エージェントは**1つの明確な目的**を持つべきです。

**良い例**:
- `finance-article-writer`: 金融記事の初稿を生成する
- `quality-checker`: コード品質の検証と修正を行う
- `debugger`: 体系的なデバッグを実行する

**悪い例**:
- `general-helper`: あらゆることをやろうとする
- `code-and-docs`: コード実装とドキュメント作成の両方を担当

### 2. 明確な境界（Clear Boundaries）

エージェントの**責任範囲**と**制約**を明確に定義します。

```yaml
責任範囲:
  - 何をするか（Responsibilities）
  - 何をしないか（Out of Scope）
  - どこまで自動化するか（Automation Level）

制約:
  - 利用可能なツール
  - アクセス可能なリソース
  - セキュリティ制限
```

### 3. 実用性重視（Practical Focus）

理論的な完璧さよりも、**実際の使用シーン**での有用性を優先します。

- 現実的なユースケースを想定
- 具体的な入力/出力例を提供
- エラーケースと対処法を明記

### 4. 検証可能性（Testability）

エージェントの動作を**検証可能**に設計します。

- 明確な入力と期待される出力
- 完了条件のチェックリスト
- 品質基準の定義

## エージェントカテゴリ

### specialized-domains（専門領域）

汎用的なタスクを専門的に処理するエージェント。

**用途**:
- コード品質管理（quality-checker）
- デバッグ（debugger）
- セキュリティスキャン（security-scanner）
- エージェント設計（agent-expert）

**特徴**:
- プロジェクト横断的に使用可能
- 標準的なプロセスを自動化
- ドメイン固有の専門知識を持つ

### finance関連カテゴリ

金融記事作成ワークフローに特化したエージェント。

**カテゴリ構成**:
- `market_report`: 市場レポート記事
- `stock_analysis`: 個別銘柄分析記事
- `economic_indicators`: 経済指標解説記事
- `investment_education`: 投資教育記事
- `quant_analysis`: クオンツ分析記事

**特徴**:
- 記事カテゴリごとに最適化
- ワークフローステップに応じた処理
- テンプレートとの連携

### カスタムカテゴリの作成

新しいドメインには新しいカテゴリを作成できます：

```yaml
カテゴリ命名規則:
  - kebab-case を使用
  - 具体的で説明的な名前
  - 他のカテゴリと重複しない

例:
  - data-engineering
  - api-development
  - infrastructure-automation
```

## プロンプトエンジニアリング

### フロントマター設計

```yaml
---
name: agent-name              # 必須: kebab-case、ファイル名と一致
category: category-name       # オプション: エージェントのカテゴリ
description: |                # 必須: Task tool に表示される説明（簡潔に）
  What this agent does and when to use it.
color: green                   # 必須: 表示色（lime, blue, purple, orange, cyan, yellow など）
skills: [skill-name]          # オプション: 参照するスキル
allowed-tools: Read, Write    # オプション: 使用可能なツール
model: inherit                # オプション: inherit | sonnet | haiku | opus
---
```

**フロントマター検証の詳細**は `./frontmatter-review.md` を参照してください。

**description の書き方**:
- 1-2文で簡潔に
- トリガーキーワードを含める
- 「いつ使うか」を明確に

**例**:
```yaml
# 良い例
description: コード品質の検証・自動修正を行う統合サブエージェント。モードに応じて検証のみ、自動修正、クイックチェックを実行。

# 悪い例
description: コードをチェックする
```

### プロンプト構造

#### 1. 導入部（Agent Identity）

```markdown
# [エージェント名]

あなたは[エージェントの役割]です。

## 目的

このエージェントは[具体的な目的]を実行します。
```

**ポイント**:
- エージェントの役割を明確に定義
- ユーザーとの関係性を示す
- 期待される専門性を説明

#### 2. When to Use（使用タイミング）

```markdown
## いつ使用するか

### プロアクティブ使用
- [自動的に検討すべきシナリオ1]
- [自動的に検討すべきシナリオ2]

### 明示的な使用
- [ユーザーが直接要求する場合]
- [特定のコマンド]
```

**ポイント**:
- 明確なトリガー条件を列挙
- プロアクティブ使用のガイドライン
- ユーザー要求のパターン

#### 3. Process（処理フロー）

```markdown
## 処理フロー

### ステップ 1: [ステップ名]

[具体的な処理内容]

```bash
# コマンド例
command here
```

**チェックポイント**:
- [ ] [検証項目1]
- [ ] [検証項目2]

### ステップ 2: [次のステップ]
...
```

**ポイント**:
- 明確なステップバイステップガイド
- 各ステップの目的と期待される結果
- 検証可能なチェックポイント
- 具体的なコマンド例

#### 4. Examples（実例）

```markdown
## 使用例

### ユースケース 1: [シナリオ名]

**状況**: [背景と条件]

**入力**:
```
[具体的な入力例]
```

**処理**:
1. [ステップ1]
2. [ステップ2]

**出力**:
```
[期待される出力]
```

**補足**: [注意点や追加情報]
```

**ポイント**:
- 3-4個の現実的なユースケース
- 具体的な入力/出力例
- コンテキストと背景情報
- エッジケースや注意点

#### 5. Guidelines（ガイドライン）

```markdown
## ガイドライン

### MUST（必須）
- [ ] [必ず守るべき規則1]
- [ ] [必ず守るべき規則2]

### NEVER（禁止）
- [ ] [絶対にしてはいけないこと1]
- [ ] [絶対にしてはいけないこと2]

### SHOULD（推奨）
- [推奨される行動1]
- [推奨される行動2]

### セキュリティ考慮事項
- [セキュリティ制約1]
- [セキュリティ制約2]
```

**ポイント**:
- 明確な規則と制約
- セキュリティとプライバシー考慮
- エラーハンドリングのガイドライン
- パフォーマンス最適化のヒント

#### 6. Output Format（出力形式）

```markdown
## 出力フォーマット

```yaml
レポート構造:
  セクション1: [内容]
  セクション2: [内容]

結果:
  - 項目1: [値]
  - 項目2: [値]
```

または Markdown テーブル、チェックリストなど
```

**ポイント**:
- 一貫性のある出力形式
- 構造化されたレポート
- ユーザーが理解しやすい表現

## ツールの指定

### allowed-tools の使用

スキルでツールを制限する場合：

```yaml
---
name: skill-name
allowed-tools: Read, Write, Glob
---
```

**注意**: エージェントは通常すべてのツールにアクセス可能です。
制限が必要な場合のみ `allowed-tools` を使用してください。

### ツール使用のガイドライン

```markdown
## ツールの使用

### Read Tool
[Read ツールの使い方と例]

### Write Tool
[Write ツールの使い方と例]

### AskUserQuestion Tool
[いつ、どのように使うか]
```

## 品質保証基準

### エージェントチェックリスト

作成したエージェントが以下を満たすか確認：

#### 構造
- [ ] フロントマターが正しく設定されている
- [ ] name がファイル名と一致（kebab-case）
- [ ] description が簡潔で適切
- [ ] category が適切に設定されている

#### 内容
- [ ] エージェントの役割が明確
- [ ] 使用タイミングが具体的
- [ ] 処理フローがステップバイステップ
- [ ] 3-4個の実用的な例がある
- [ ] ガイドラインが明確（MUST/NEVER）

#### 実用性
- [ ] 実際に使用可能なシナリオ
- [ ] 具体的な入力/出力例
- [ ] エラーケースへの対処
- [ ] 完了条件が検証可能

#### セキュリティ
- [ ] 適切な制約と検証
- [ ] 機密情報の取り扱い
- [ ] 破壊的操作の防止

#### ドキュメント
- [ ] 明確で理解しやすい説明
- [ ] 実践的な例とコード
- [ ] トラブルシューティング情報

## トラブルシューティング

### エージェントが呼び出されない

**原因**:
1. description にトリガーキーワードがない
2. カテゴリが適切でない
3. より特化したエージェントが優先されている

**対処法**:
- description を見直し、明確なトリガーワードを追加
- カテゴリを確認・変更
- 他のエージェントとの重複を確認

### エージェントが期待通りに動作しない

**原因**:
1. プロンプトが曖昧
2. 処理フローが不明確
3. 例が現実的でない
4. ツールの使用方法が不適切

**対処法**:
- より具体的で明確なプロンプトに修正
- ステップバイステップガイドを追加
- 実用的な例を追加
- ツール使用の例を含める

### エージェント間の責任が重複

**原因**:
1. 責任範囲が不明確
2. 抽象度が適切でない
3. ユースケースが重複

**対処法**:
- 各エージェントの境界を明確に定義
- より特化したエージェントを優先
- 必要に応じて統合または分割

### パフォーマンスの問題

**原因**:
1. 不要な処理が含まれている
2. ツール呼び出しが非効率
3. プロンプトが長すぎる

**対処法**:
- 処理フローを最適化
- 並列実行可能な処理を特定
- プロンプトを簡潔に

## エージェント設計パターン

### 1. ワークフローエージェント

複数のステップを順次実行するエージェント。

**特徴**:
- 明確なステップバイステップガイド
- 各ステップの検証ポイント
- 状態管理とエラーリカバリー

**例**: `finance-research`, `ensure-quality`

### 2. 分析エージェント

データやコードを分析してレポートを生成するエージェント。

**特徴**:
- 入力データの検証
- 分析ロジックの説明
- 構造化されたレポート出力

**例**: `code-analyzer`, `finance-technical-analysis`

### 3. 批評エージェント

成果物を評価してフィードバックを提供するエージェント。

**特徴**:
- 明確な評価基準
- スコアリングシステム
- 改善提案

**例**: `finance-critic-data`, `finance-critic-compliance`

### 4. 生成エージェント

新しいコンテンツやコードを生成するエージェント。

**特徴**:
- テンプレートの使用
- カスタマイズ可能なパラメータ
- 品質検証

**例**: `finance-article-writer`, `test-writer`

### 5. 検証エージェント

品質、セキュリティ、準拠性を検証するエージェント。

**特徴**:
- チェックリストベースの検証
- 自動修正機能（オプション）
- 詳細なレポート

**例**: `quality-checker`, `security-scanner`

## ベストプラクティス

### DO（推奨）

1. **具体的な例を含める**
   - 実際の使用シナリオを示す
   - 入力と出力の例を提供
   - エッジケースを含める

2. **段階的な処理フロー**
   - ステップを小さく分割
   - 各ステップを検証可能に
   - 進捗を可視化

3. **エラーハンドリング**
   - 予想されるエラーを列挙
   - 対処法を明記
   - ユーザーへの明確なメッセージ

4. **ユーザーインタラクション**
   - 必要に応じて質問する
   - 進捗を報告する
   - 完了を明確に示す

### DON'T（避けるべき）

1. **曖昧な説明**
   - 「適切に処理する」
   - 「必要に応じて修正する」
   - 具体性のない指示

2. **過度な自動化**
   - ユーザー確認なしの破壊的操作
   - 重要な決定の自動化
   - 説明のない大規模変更

3. **責任範囲の曖昧さ**
   - 「何でもできる」エージェント
   - 重複する責任
   - 不明確な境界

4. **テスト不可能な設計**
   - 検証できない完了条件
   - 主観的な成功基準
   - 不明確な出力形式

## テンプレートの活用

このスキルに含まれる `template.md` を使用して、
新しいエージェントを効率的に作成できます。

テンプレートには：
- 標準的なフロントマター構造
- セクション構成
- コメント付きガイド
- 記入例

が含まれています。

## まとめ

優れたエージェント設計の鍵：

1. **明確な目的**: 何をするエージェントか一言で説明できる
2. **具体的なガイド**: ステップバイステップで再現可能
3. **実用的な例**: 実際の使用シーンを示す
4. **適切な境界**: 責任範囲と制約が明確
5. **検証可能性**: 成功/失敗を客観的に判定できる

これらの原則に従って、
ユーザーにとって価値のあるエージェントを設計してください。
