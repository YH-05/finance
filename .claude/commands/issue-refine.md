---
description: GitHub Issue の内容をブラッシュアップして更新する
---

# /issue-refine - Issue ブラッシュアップ

> **役割の明確化**: このコマンドは **既存 Issue の内容改善** に特化しています。
>
> - 新規 Issue 作成・タスク分解 → `/issue`
> - コメントからの進捗同期 → `/sync-issue`

**目的**: 既存の GitHub Issue を明確化・具体化し、テンプレートに準拠した形式に改善する

## コマンド構文

```bash
# 単一 Issue のブラッシュアップ
/issue-refine 123

# 複数 Issue のブラッシュアップ
/issue-refine 123 124 125

# project.md に紐づく全 Issue をブラッシュアップ
/issue-refine @src/<library_name>/docs/project.md
/issue-refine @docs/project/<project-slug>.md
```

## 概要

1. Issue 番号または project.md パスを解析
2. Issue 情報を取得
3. 改善対象をユーザーに確認
4. **不明点をユーザーに確認（詳細を尋ねる）**
5. AI で改善案を生成
6. 差分を表示してユーザーに確認
7. 承認後に Issue を更新
8. 結果を表示

---

## ステップ 0: 引数解析

### パターン A: Issue 番号指定

- 形式: `123` または `123 124 125`（数値のみ、`#` は不要）
- 抽出: スペース区切りで数値を Issue 番号として取得
- 複数指定された場合は順番に処理

### パターン B: project.md パス指定

- 形式: `@src/<library_name>/docs/project.md` または `@docs/project/<slug>.md`
- 処理:
  1. project.md を読み込み
  2. `Issue: [#番号](URL)` から全 Issue 番号を抽出
  3. 抽出した全 Issue を対象にブラッシュアップ

**引数が不正な場合**:

```text
エラー: 引数の形式が正しくありません。

使用例:
- 単一 Issue: /issue-refine 123
- 複数 Issue: /issue-refine 123 124 125
- project.md: /issue-refine @src/market_analysis/docs/project.md
```

---

## ステップ 1: Issue 情報取得

### 1.1 リポジトリ情報の取得

```bash
gh repo view --json owner,name -q '"\(.owner.login)/\(.name)"'
```

### 1.2 Issue 情報の取得

各 Issue について以下を実行:

```bash
gh issue view {issue_number} --json number,title,body,state,labels,url
```

**Issue が存在しない場合**:

```text
エラー: Issue #{number} が見つかりません。
```

**認証エラーの場合**:

```text
エラー: GitHub 認証に失敗しました。

解決方法:
gh auth login
```

---

## ステップ 2: 改善対象の選択

AskUserQuestion ツールで改善対象を選択:

```yaml
questions:
  - question: "Issue #{number} のどの部分を改善しますか？"
    header: "改善対象"
    options:
      - label: "本文全体"
        description: "概要・詳細・受け入れ条件すべてを改善"
      - label: "受け入れ条件のみ"
        description: "測定可能で明確な条件に洗練"
      - label: "タイトルと概要"
        description: "タイトルと概要セクションを改善"
```

---

## ステップ 2.5: ユーザーへの詳細確認

**目的**: Issue の不明点・曖昧な点をユーザーに確認し、改善案生成に必要な情報を収集する

### 2.5.1 不明点の抽出

Issue の内容を分析し、以下の観点で不明点を抽出:

1. **背景・目的の不明点**
   - なぜこの機能/修正が必要か
   - どのような問題を解決するか
   - 誰が使うのか（ターゲットユーザー）

2. **実装内容の不明点**
   - 具体的な実装方法・技術選択
   - スコープ（何をやる/やらない）
   - 既存機能との関係

3. **受け入れ条件の不明点**
   - 完了の判断基準
   - 測定可能な成功指標
   - テスト方法

4. **制約・依存関係の不明点**
   - 技術的制約
   - 他の Issue との依存関係
   - リソース制約（時間、予算など）

### 2.5.2 質問の生成

不明点ごとに AskUserQuestion で質問を作成（最大 4 つまで）:

```yaml
questions:
  - question: "この機能の主な目的は何ですか？"
    header: "目的"
    multiSelect: false
    options:
      - label: "運用効率化"
        description: "既存業務の効率化・自動化"
      - label: "新機能追加"
        description: "新しい機能の提供"
      - label: "問題解決"
        description: "既存の問題・バグの修正"
      - label: "品質改善"
        description: "パフォーマンス・保守性の向上"

  - question: "実装のスコープはどこまでですか？"
    header: "スコープ"
    multiSelect: true
    options:
      - label: "基本機能のみ"
        description: "最小限の機能実装"
      - label: "エラーハンドリング"
        description: "例外処理・バリデーション含む"
      - label: "テスト実装"
        description: "ユニットテスト・統合テスト含む"
      - label: "ドキュメント"
        description: "README・API ドキュメント含む"

  - question: "他の機能との連携はありますか？"
    header: "連携"
    multiSelect: true
    options:
      - label: "単独動作"
        description: "他機能に依存しない"
      - label: "既存機能を利用"
        description: "既存のモジュール・API を使用"
      - label: "既存機能を拡張"
        description: "既存機能に機能追加"
      - label: "新規統合"
        description: "外部サービス・ライブラリと統合"

  - question: "優先度と期限について教えてください"
    header: "優先度"
    multiSelect: false
    options:
      - label: "緊急（P0）"
        description: "今すぐ対応が必要"
      - label: "高（P1）"
        description: "1週間以内に対応"
      - label: "中（P2）"
        description: "1ヶ月以内に対応"
      - label: "低（P3）"
        description: "いつでもよい"
```

### 2.5.3 追加の自由記述質問

選択肢で不足する情報を自由記述で収集:

**質問例**:
- 「この機能を使う具体的なユースケースを教えてください」
- 「受け入れ条件として、どのような状態になれば完了と判断しますか？」
- 「実装時に特に注意すべき点はありますか？」
- 「関連する Issue や参考資料があれば教えてください」

### 2.5.4 確認情報の整理

ユーザーの回答を構造化して保存:

```json
{
  "purpose": "運用効率化",
  "scope": ["基本機能のみ", "エラーハンドリング", "テスト実装"],
  "integration": ["既存機能を利用"],
  "priority": "中（P2）",
  "use_cases": "ユーザーの自由記述",
  "acceptance_criteria_detail": "ユーザーの自由記述",
  "notes": "ユーザーの自由記述",
  "related_issues": ["#123", "#456"]
}
```

### 2.5.5 確認情報のサマリー表示

収集した情報をユーザーに確認:

```markdown
## 確認した詳細情報

- **目的**: 運用効率化
- **スコープ**: 基本機能のみ、エラーハンドリング、テスト実装
- **連携**: 既存機能を利用
- **優先度**: 中（P2）

### ユースケース
{ユーザーの自由記述}

### 受け入れ条件の詳細
{ユーザーの自由記述}

### 実装時の注意点
{ユーザーの自由記述}

### 関連 Issue
- #123: {タイトル}
- #456: {タイトル}

この情報で改善案を生成してよろしいですか？
```

最終確認:

```yaml
questions:
  - question: "この情報で改善案を生成しますか？"
    header: "最終確認"
    multiSelect: false
    options:
      - label: "生成する"
        description: "この情報で改善案を作成"
      - label: "修正する"
        description: "情報を修正してから生成"
      - label: "キャンセル"
        description: "このIssueのブラッシュアップをキャンセル"
```

---

## ステップ 3: 改善案の生成

**重要**: ステップ 2.5 で収集した詳細情報を**必ず反映**して改善案を生成すること

### 3.1 Issue テンプレート（改善の基準）

```markdown
## 概要
[機能・問題の概要を1-2文で簡潔に記述]

## 詳細
[実装の詳細、技術的な背景、コンテキストを記述]

## 受け入れ条件
- [ ] [測定可能な条件1: 具体的な数値や状態を含む]
- [ ] [測定可能な条件2: 「〜ができること」形式]
- [ ] [測定可能な条件3: テスト可能な表現]

## 備考
[補足情報、関連 Issue、参考リンクなど]
```

### 3.2 改善ガイドライン

#### タイトル改善

| 改善前 | 改善後 |
|--------|--------|
| バグ修正 | ログイン時に 500 エラーが発生する問題を修正 |
| 機能追加 | ユーザープロフィールに SNS 連携機能を追加 |
| リファクタ | 認証モジュールを Strategy パターンでリファクタリング |

#### 概要改善

| 改善前 | 改善後 |
|--------|--------|
| 処理が遅い | API レスポンスが 3 秒以上かかるケースがある |
| UIを改善したい | モバイル表示時にボタンが画面外にはみ出す |

#### 受け入れ条件改善

| 改善前（曖昧） | 改善後（測定可能） |
|----------------|-------------------|
| パフォーマンスが改善される | 平均レスポンスタイムが 500ms 以下になる |
| テストが通る | `make test` が成功する |
| ドキュメントがある | README.md に使用例が記載されている |
| 使いやすい | フォーム入力が 3 ステップ以内で完了する |
| バグが直る | エラーログに該当例外が出力されない |

### 3.3 改善プロンプト

改善対象に応じて以下の観点で改善（**ステップ 2.5 で収集した情報を必ず活用**）:

**本文全体の場合**:
1. タイトルを具体的かつ簡潔に
2. 概要を 1-2 文で明確に（ユーザー確認情報の「目的」「ユースケース」を反映）
3. 詳細セクションに技術的コンテキストを追加（「スコープ」「連携」「注意点」を反映）
4. 受け入れ条件を測定可能な形式に（「受け入れ条件の詳細」を具体化）
5. 不足しているセクションを補完（「関連 Issue」「優先度」を追加）

**受け入れ条件のみの場合**:
1. 曖昧な条件を具体的な数値・状態に変換（ユーザー確認情報の「受け入れ条件の詳細」を活用）
2. 「〜ができること」形式に統一
3. テスト可能な表現に変更（「スコープ」でテスト実装が含まれる場合は明記）
4. 重複を排除

**タイトルと概要の場合**:
1. タイトルを [種類]: [具体的な内容] 形式に（「目的」を反映）
2. 概要を問題・解決策・効果の構造で記述（「ユースケース」を活用）

### 3.4 改善案への情報反映チェックリスト

改善案生成時に以下を確認:

- [ ] ユーザー確認情報の「目的」が概要に反映されている
- [ ] 「スコープ」が詳細セクションに明記されている
- [ ] 「連携」が詳細セクションまたは関連 Issue に記載されている
- [ ] 「優先度」が備考または Issue ラベルとして設定されている
- [ ] 「ユースケース」が概要または詳細に含まれている
- [ ] 「受け入れ条件の詳細」が測定可能な受け入れ条件に変換されている
- [ ] 「実装時の注意点」が詳細または備考に記載されている
- [ ] 「関連 Issue」が備考セクションに追加されている

---

## ステップ 4: 差分表示と確認

### 4.1 差分表示

改善前後を比較表示:

```markdown
## Issue #{number}: {title}

### タイトル
- **改善前**: {old_title}
- **改善後**: {new_title}

### 本文の変更

#### 概要
```diff
- [改善前の概要]
+ [改善後の概要]
```

#### 受け入れ条件
```diff
- [ ] 改善前の条件1
- [ ] 改善前の条件2
+ [ ] 改善後の条件1（測定可能）
+ [ ] 改善後の条件2（測定可能）
+ [ ] 改善後の条件3（追加）
```
```

### 4.2 確認ダイアログ

AskUserQuestion ツールで確認:

```yaml
questions:
  - question: "この改善案を Issue #{number} に適用しますか？"
    header: "適用確認"
    options:
      - label: "適用する"
        description: "改善案で Issue を更新"
      - label: "修正して適用"
        description: "改善案を編集してから適用"
      - label: "スキップ"
        description: "この Issue の更新をスキップ"
```

### 4.3 修正して適用（選択時）

```yaml
questions:
  - question: "どの部分を修正しますか？"
    header: "修正箇所"
    multiSelect: true
    options:
      - label: "タイトル"
        description: "タイトルを手動で修正"
      - label: "概要"
        description: "概要を手動で修正"
      - label: "受け入れ条件"
        description: "受け入れ条件を手動で修正"
```

選択後、自由入力で修正内容を受け付け、再度確認ダイアログを表示。

---

## ステップ 5: Issue 更新

### 5.1 タイトル更新

```bash
gh issue edit {issue_number} --title "{new_title}"
```

### 5.2 本文更新

```bash
gh issue edit {issue_number} --body "$(cat <<'EOF'
{new_body}
EOF
)"
```

### 5.3 更新履歴コメント

Issue に更新履歴をコメントとして追加（オプション）:

```bash
gh issue comment {issue_number} --body "$(cat <<'EOF'
## Issue ブラッシュアップ

このIssueは `/issue-refine` コマンドにより以下の改善が行われました:

- タイトル: より具体的な表現に変更
- 受け入れ条件: 測定可能な形式に変更

---
🤖 Generated by Claude Code
EOF
)"
```

---

## ステップ 6: 結果表示

処理結果を表示:

```markdown
## ブラッシュアップ結果

### 更新した Issue

| Issue | タイトル | 改善内容 |
|-------|----------|----------|
| [#123](URL) | 新しいタイトル | 本文全体を改善 |
| [#124](URL) | 新しいタイトル | 受け入れ条件を改善 |

### スキップした Issue

| Issue | 理由 |
|-------|------|
| [#125](URL) | ユーザーによりスキップ |

### 改善サマリー

- **タイトル改善**: 2 件
- **概要改善**: 2 件
- **受け入れ条件改善**: 3 件（計 8 条件を明確化）

## 次のステップ

- `/issue` で project.md との同期状況を確認
- 改善した Issue の実装を開始
```

---

## 複数 Issue 処理時の動作

複数 Issue が指定された場合:

1. 各 Issue を順番に処理
2. 各 Issue ごとに確認ダイアログを表示
3. 「すべてに同じ設定を適用」オプションを提供:

```yaml
questions:
  - question: "残り {count} 件の Issue にも同じ改善設定を適用しますか？"
    header: "一括設定"
    options:
      - label: "同じ設定で続行"
        description: "残りの Issue も同じ改善対象で処理"
      - label: "個別に設定"
        description: "各 Issue ごとに改善対象を選択"
```

---

## エラーハンドリング

| ケース | 対処 |
|--------|------|
| GitHub 認証エラー | `gh auth login` を案内 |
| Issue が存在しない | エラーメッセージを表示、次の Issue へ |
| Issue 更新権限なし | 権限不足を通知 |
| 本文が空の Issue | テンプレートを適用して新規作成 |
| closed Issue | 警告を表示、続行するか確認 |

---

## 完了条件

このワークフローは、以下の全ての条件を満たした時点で完了:

- ステップ 0: 引数が正しく解析されている
- ステップ 1: Issue 情報が取得されている
- ステップ 2: 改善対象が選択されている
- **ステップ 2.5: ユーザーから詳細情報が収集されている**
- ステップ 3: 改善案が生成されている（ステップ 2.5 の情報を反映）
- ステップ 4: ユーザー確認が完了している
- ステップ 5: 承認された Issue が更新されている
- ステップ 6: 結果が表示されている

## 重要な注意事項

1. **ステップ 2.5 は必須**: Issue の不明点を明らかにするため、必ずユーザーに詳細を確認すること
2. **情報の反映**: ステップ 2.5 で収集した情報は、改善案に**漏れなく**反映すること
3. **測定可能性**: 受け入れ条件は、ユーザー確認情報を元に必ず測定可能な形式にすること
4. **関連情報**: 関連 Issue、優先度、スコープなどの情報は必ず備考セクションに記載すること
