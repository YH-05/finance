---
description: GitHub Issue の内容をブラッシュアップして更新する
---

# /issue-refine - Issue ブラッシュアップ

> **役割の明確化**: このコマンドは **既存 Issue の内容改善** に特化しています。
>
> - 新規 Issue 作成・タスク分解 → `/issue`
> - コメントからの進捗同期 → `/sync-issue`

**目的**: 既存の GitHub Issue を明確化・具体化し、テンプレートに準拠した形式に改善する

## コマンド構文

```bash
# 単一 Issue のブラッシュアップ
/issue-refine 123

# 複数 Issue のブラッシュアップ
/issue-refine 123 124 125

# project.md に紐づく全 Issue をブラッシュアップ
/issue-refine @src/<library_name>/docs/project.md
/issue-refine @docs/project/<project-slug>.md
```

## 概要

1. Issue 番号または project.md パスを解析
2. Issue 情報を取得
3. 改善対象をユーザーに確認
4. AI で改善案を生成
5. 差分を表示してユーザーに確認
6. 承認後に Issue を更新
7. 結果を表示

---

## ステップ 0: 引数解析

### パターン A: Issue 番号指定

- 形式: `123` または `123 124 125`（数値のみ、`#` は不要）
- 抽出: スペース区切りで数値を Issue 番号として取得
- 複数指定された場合は順番に処理

### パターン B: project.md パス指定

- 形式: `@src/<library_name>/docs/project.md` または `@docs/project/<slug>.md`
- 処理:
  1. project.md を読み込み
  2. `Issue: [#番号](URL)` から全 Issue 番号を抽出
  3. 抽出した全 Issue を対象にブラッシュアップ

**引数が不正な場合**:

```text
エラー: 引数の形式が正しくありません。

使用例:
- 単一 Issue: /issue-refine 123
- 複数 Issue: /issue-refine 123 124 125
- project.md: /issue-refine @src/market_analysis/docs/project.md
```

---

## ステップ 1: Issue 情報取得

### 1.1 リポジトリ情報の取得

```bash
gh repo view --json owner,name -q '"\(.owner.login)/\(.name)"'
```

### 1.2 Issue 情報の取得

各 Issue について以下を実行:

```bash
gh issue view {issue_number} --json number,title,body,state,labels,url
```

**Issue が存在しない場合**:

```text
エラー: Issue #{number} が見つかりません。
```

**認証エラーの場合**:

```text
エラー: GitHub 認証に失敗しました。

解決方法:
gh auth login
```

---

## ステップ 2: 改善対象の選択

AskUserQuestion ツールで改善対象を選択:

```yaml
questions:
  - question: "Issue #{number} のどの部分を改善しますか？"
    header: "改善対象"
    options:
      - label: "本文全体"
        description: "概要・詳細・受け入れ条件すべてを改善"
      - label: "受け入れ条件のみ"
        description: "測定可能で明確な条件に洗練"
      - label: "タイトルと概要"
        description: "タイトルと概要セクションを改善"
```

---

## ステップ 3: 改善案の生成

### 3.1 Issue テンプレート（改善の基準）

```markdown
## 概要
[機能・問題の概要を1-2文で簡潔に記述]

## 詳細
[実装の詳細、技術的な背景、コンテキストを記述]

## 受け入れ条件
- [ ] [測定可能な条件1: 具体的な数値や状態を含む]
- [ ] [測定可能な条件2: 「〜ができること」形式]
- [ ] [測定可能な条件3: テスト可能な表現]

## 備考
[補足情報、関連 Issue、参考リンクなど]
```

### 3.2 改善ガイドライン

#### タイトル改善

| 改善前 | 改善後 |
|--------|--------|
| バグ修正 | ログイン時に 500 エラーが発生する問題を修正 |
| 機能追加 | ユーザープロフィールに SNS 連携機能を追加 |
| リファクタ | 認証モジュールを Strategy パターンでリファクタリング |

#### 概要改善

| 改善前 | 改善後 |
|--------|--------|
| 処理が遅い | API レスポンスが 3 秒以上かかるケースがある |
| UIを改善したい | モバイル表示時にボタンが画面外にはみ出す |

#### 受け入れ条件改善

| 改善前（曖昧） | 改善後（測定可能） |
|----------------|-------------------|
| パフォーマンスが改善される | 平均レスポンスタイムが 500ms 以下になる |
| テストが通る | `make test` が成功する |
| ドキュメントがある | README.md に使用例が記載されている |
| 使いやすい | フォーム入力が 3 ステップ以内で完了する |
| バグが直る | エラーログに該当例外が出力されない |

### 3.3 改善プロンプト

改善対象に応じて以下の観点で改善:

**本文全体の場合**:
1. タイトルを具体的かつ簡潔に
2. 概要を 1-2 文で明確に
3. 詳細セクションに技術的コンテキストを追加
4. 受け入れ条件を測定可能な形式に
5. 不足しているセクションを補完

**受け入れ条件のみの場合**:
1. 曖昧な条件を具体的な数値・状態に変換
2. 「〜ができること」形式に統一
3. テスト可能な表現に変更
4. 重複を排除

**タイトルと概要の場合**:
1. タイトルを [種類]: [具体的な内容] 形式に
2. 概要を問題・解決策・効果の構造で記述

---

## ステップ 4: 差分表示と確認

### 4.1 差分表示

改善前後を比較表示:

```markdown
## Issue #{number}: {title}

### タイトル
- **改善前**: {old_title}
- **改善後**: {new_title}

### 本文の変更

#### 概要
```diff
- [改善前の概要]
+ [改善後の概要]
```

#### 受け入れ条件
```diff
- [ ] 改善前の条件1
- [ ] 改善前の条件2
+ [ ] 改善後の条件1（測定可能）
+ [ ] 改善後の条件2（測定可能）
+ [ ] 改善後の条件3（追加）
```
```

### 4.2 確認ダイアログ

AskUserQuestion ツールで確認:

```yaml
questions:
  - question: "この改善案を Issue #{number} に適用しますか？"
    header: "適用確認"
    options:
      - label: "適用する"
        description: "改善案で Issue を更新"
      - label: "修正して適用"
        description: "改善案を編集してから適用"
      - label: "スキップ"
        description: "この Issue の更新をスキップ"
```

### 4.3 修正して適用（選択時）

```yaml
questions:
  - question: "どの部分を修正しますか？"
    header: "修正箇所"
    multiSelect: true
    options:
      - label: "タイトル"
        description: "タイトルを手動で修正"
      - label: "概要"
        description: "概要を手動で修正"
      - label: "受け入れ条件"
        description: "受け入れ条件を手動で修正"
```

選択後、自由入力で修正内容を受け付け、再度確認ダイアログを表示。

---

## ステップ 5: Issue 更新

### 5.1 タイトル更新

```bash
gh issue edit {issue_number} --title "{new_title}"
```

### 5.2 本文更新

```bash
gh issue edit {issue_number} --body "$(cat <<'EOF'
{new_body}
EOF
)"
```

### 5.3 更新履歴コメント

Issue に更新履歴をコメントとして追加（オプション）:

```bash
gh issue comment {issue_number} --body "$(cat <<'EOF'
## Issue ブラッシュアップ

このIssueは `/issue-refine` コマンドにより以下の改善が行われました:

- タイトル: より具体的な表現に変更
- 受け入れ条件: 測定可能な形式に変更

---
🤖 Generated by Claude Code
EOF
)"
```

---

## ステップ 6: 結果表示

処理結果を表示:

```markdown
## ブラッシュアップ結果

### 更新した Issue

| Issue | タイトル | 改善内容 |
|-------|----------|----------|
| [#123](URL) | 新しいタイトル | 本文全体を改善 |
| [#124](URL) | 新しいタイトル | 受け入れ条件を改善 |

### スキップした Issue

| Issue | 理由 |
|-------|------|
| [#125](URL) | ユーザーによりスキップ |

### 改善サマリー

- **タイトル改善**: 2 件
- **概要改善**: 2 件
- **受け入れ条件改善**: 3 件（計 8 条件を明確化）

## 次のステップ

- `/issue` で project.md との同期状況を確認
- 改善した Issue の実装を開始
```

---

## 複数 Issue 処理時の動作

複数 Issue が指定された場合:

1. 各 Issue を順番に処理
2. 各 Issue ごとに確認ダイアログを表示
3. 「すべてに同じ設定を適用」オプションを提供:

```yaml
questions:
  - question: "残り {count} 件の Issue にも同じ改善設定を適用しますか？"
    header: "一括設定"
    options:
      - label: "同じ設定で続行"
        description: "残りの Issue も同じ改善対象で処理"
      - label: "個別に設定"
        description: "各 Issue ごとに改善対象を選択"
```

---

## エラーハンドリング

| ケース | 対処 |
|--------|------|
| GitHub 認証エラー | `gh auth login` を案内 |
| Issue が存在しない | エラーメッセージを表示、次の Issue へ |
| Issue 更新権限なし | 権限不足を通知 |
| 本文が空の Issue | テンプレートを適用して新規作成 |
| closed Issue | 警告を表示、続行するか確認 |

---

## 完了条件

このワークフローは、以下の全ての条件を満たした時点で完了:

- ステップ 0: 引数が正しく解析されている
- ステップ 1: Issue 情報が取得されている
- ステップ 2: 改善対象が選択されている
- ステップ 3: 改善案が生成されている
- ステップ 4: ユーザー確認が完了している
- ステップ 5: 承認された Issue が更新されている
- ステップ 6: 結果が表示されている
