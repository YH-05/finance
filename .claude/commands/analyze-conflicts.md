---
description: PRのコンフリクトを詳細分析し、問題点と解決策を提示
---

# /analyze-conflicts - コンフリクト分析

> **役割の明確化**: このコマンドは**コンフリクトの詳細分析**に特化しています。
>
> - PRのマージ実行 → `/merge-pr`
> - PRの詳細レビュー → `/review-pr`

**目的**: PRのコンフリクトを詳細に分析し、全てのコンフリクトファイル・問題点・解決策を提示する

## 使用例

```bash
# PR番号を指定して分析
/analyze-conflicts 36

# ローカルブランチのコンフリクトを分析（PRなし）
/analyze-conflicts --local feature/my-branch

# 詳細モード（コンフリクト箇所のコード表示）
/analyze-conflicts 36 --verbose
```

## 実行フロー

### ステップ 0: 前提条件の確認

#### 0.1 引数の確認

**引数（$ARGUMENTS）を解析**:
- PR番号: 必須（--localオプション使用時を除く）
- オプション: --local <branch>, --verbose, -v

**引数がない場合**: エラーを表示して処理を中断

```
エラー: PR番号またはブランチ名を指定してください。

使用方法:
  /analyze-conflicts <pr-number> [options]
  /analyze-conflicts --local <branch-name> [options]

オプション:
  --local <branch>  ローカルブランチのコンフリクトを分析
  --verbose, -v     コンフリクト箇所の詳細コードを表示

例:
  /analyze-conflicts 36
  /analyze-conflicts 36 --verbose
  /analyze-conflicts --local feature/my-branch
```

### ステップ 1: PR/ブランチ情報の取得

#### 1.1 PRモードの場合

```bash
gh pr view <pr-number> --json number,title,state,mergeable,mergeStateStatus,baseRefName,headRefName,url
```

**コンフリクトがない場合**:

```
✓ PR #<number> にコンフリクトはありません。

PR: <title>
状態: マージ可能

/merge-pr <number> でマージを実行できます。
```

#### 1.2 ローカルモードの場合

```bash
git rev-parse --verify <branch-name>
git merge-base main <branch-name>
```

### ステップ 2: コンフリクトファイルの特定

#### 2.1 PRモードでのコンフリクトファイル取得

GitHub APIではコンフリクトファイルの詳細が取得できないため、ローカルでシミュレート:

```bash
# 一時的にマージをシミュレート
git fetch origin
git checkout -B temp-conflict-check origin/<baseRefName>
git merge --no-commit --no-ff origin/<headRefName> 2>&1
```

#### 2.2 コンフリクトファイルの列挙

```bash
git diff --name-only --diff-filter=U
```

### ステップ 3: コンフリクトの詳細分析

#### 3.1 各ファイルのコンフリクト分析

各コンフリクトファイルについて以下を実行:

```bash
# コンフリクトマーカーの数をカウント
grep -c "^<<<<<<< " <file>

# コンフリクト箇所を抽出
grep -n -A 10 "^<<<<<<< " <file>
```

#### 3.2 コンフリクトの分類

| タイプ | 説明 | 検出方法 |
|--------|------|----------|
| 同一行変更 | 両ブランチで同じ行を変更 | マーカー間の行数が少ない |
| 隣接行変更 | 近接した行を変更 | コンテキスト重複 |
| 追加競合 | 同位置に異なる追加 | 追加行のみのコンフリクト |
| 削除競合 | 一方が削除、他方が変更 | 片側が空 |
| リネーム競合 | ファイル名変更の競合 | git statusで検出 |

### ステップ 4: 問題点の分析

#### 4.1 リスク評価

各コンフリクトについてリスクを評価:

| リスクレベル | 条件 | 説明 |
|--------------|------|------|
| **高** | ロジック変更の競合 | 両方でビジネスロジックが変更 |
| **高** | テストの競合 | テストケースが競合 |
| **中** | 型定義の競合 | 型・インターフェースが競合 |
| **中** | インポートの競合 | 依存関係が競合 |
| **低** | フォーマットの競合 | 空白・改行のみの差異 |
| **低** | コメントの競合 | コメント・ドキュメントのみ |

#### 4.2 依存関係の分析

コンフリクトファイル間の依存関係をチェック:

```bash
# インポート関係を確認
grep -l "from.*<conflicted_module>" src/**/*.py
```

### ステップ 5: 結果の出力

#### 5.1 サマリー表示

```
================================================================================
                      コンフリクト分析レポート
================================================================================

PR情報:
  番号: #<number>
  タイトル: <title>
  URL: <url>

ブランチ情報:
  ベース: <baseRefName>
  ヘッド: <headRefName>
  分岐点からのコミット数: <commit_count>

================================================================================
                         コンフリクトサマリー
================================================================================

コンフリクトファイル数: <count>
総コンフリクト箇所数: <total_conflicts>

リスク分布:
  高: <high_count> 件
  中: <medium_count> 件
  低: <low_count> 件

================================================================================
```

#### 5.2 ファイル別詳細

```
================================================================================
                      ファイル別コンフリクト詳細
================================================================================

[1/N] src/example/module.py
--------------------------------------------------------------------------------
リスクレベル: 高
コンフリクト箇所: 3 箇所
タイプ: 同一行変更

問題点:
  - L45-52: 両ブランチで `process_data` 関数のロジックを変更
  - L78-85: 例外ハンドリングの方法が異なる
  - L120-125: 戻り値の型が異なる

影響範囲:
  - このファイルをインポートしているモジュール: 5 個
  - 関連テスト: tests/unit/test_module.py

推奨解決策:
  1. main側の変更意図を確認（コミット: abc1234）
  2. feature側の変更意図を確認（コミット: def5678）
  3. 両方の変更を統合するか、どちらかを優先するか決定

--------------------------------------------------------------------------------

[2/N] src/example/types.py
--------------------------------------------------------------------------------
...
```

#### 5.3 verboseモード追加出力

```
================================================================================
                      コンフリクト箇所の詳細
================================================================================

[1/N] src/example/module.py:45-52
--------------------------------------------------------------------------------

<<<<<<< HEAD (main)
def process_data(data: list[dict]) -> ProcessResult:
    """Process data with validation."""
    validated = validate_all(data)
    return ProcessResult(items=validated, count=len(validated))
=======
def process_data(data: list[dict], strict: bool = False) -> ProcessResult:
    """Process data with optional strict mode."""
    if strict:
        validated = validate_strict(data)
    else:
        validated = validate_all(data)
    return ProcessResult(items=validated, count=len(validated), strict=strict)
>>>>>>> feature/my-branch

分析:
  - main: バリデーション処理をシンプルに維持
  - feature: strictモードオプションを追加
  - 統合案: strictオプションを追加しつつ、デフォルト動作は維持

--------------------------------------------------------------------------------
```

### ステップ 6: 解決ガイドの提示

#### 6.1 解決手順

```
================================================================================
                         解決ガイド
================================================================================

推奨される解決手順:

1. ローカルでの準備
   git fetch origin
   git checkout <headRefName>
   git merge origin/<baseRefName>

2. コンフリクトの解決（優先順位順）

   [優先度: 高] src/example/module.py
   - 両方の変更を理解してから統合
   - テストが通ることを確認

   [優先度: 中] src/example/types.py
   - 型定義の整合性を確認

   [優先度: 低] src/example/config.py
   - フォーマットのみの差異、どちらでも可

3. 解決後の確認
   make check-all

4. プッシュ
   git add .
   git commit -m "resolve: merge conflicts with main"
   git push

5. マージ
   /merge-pr <number>

================================================================================
```

#### 6.2 自動解決可能なコンフリクト

```
================================================================================
                      自動解決候補
================================================================================

以下のコンフリクトは自動解決が可能です:

| ファイル | 理由 | 推奨 |
|----------|------|------|
| pyproject.toml | バージョン番号のみ | main側を採用 |
| .gitignore | 追加行の競合 | 両方を採用 |

自動解決を実行しますか？
1. はい（上記ファイルを自動解決）
2. いいえ（手動で解決）
```

## オプション一覧

| オプション | 短縮形 | 説明 | デフォルト |
|------------|--------|------|------------|
| `--local` | - | ローカルブランチを分析 | - |
| `--verbose` | `-v` | 詳細なコード差分を表示 | - |

## 出力例（簡易版）

```
================================================================================
                      コンフリクト分析レポート
================================================================================

PR #36: feat: add preset groups and enhanced ticker registry API

コンフリクトファイル: 3 件
  [高] src/market_analysis/registry.py (2箇所)
      - L45: レジストリ初期化ロジックの競合
      - L89: プリセット追加メソッドの競合

  [中] src/market_analysis/types.py (1箇所)
      - L23: TickerInfo型の定義競合

  [低] tests/conftest.py (1箇所)
      - L12: フィクスチャの順序競合

解決の推奨順序: registry.py → types.py → conftest.py

詳細を表示: /analyze-conflicts 36 --verbose
================================================================================
```

## エラーハンドリング

| 状況 | 対処 |
|------|------|
| PR番号未指定 | 使用方法を表示して終了 |
| PRが存在しない | エラーメッセージを表示して終了 |
| コンフリクトなし | 「マージ可能」と表示して終了 |
| ブランチが存在しない | エラーメッセージを表示して終了 |
| Git操作エラー | エラー詳細を表示して終了 |

## 関連コマンド

| コマンド | 説明 |
|----------|------|
| `/merge-pr` | PRのマージ実行 |
| `/review-pr` | PRの詳細レビュー |
| `/commit-and-pr` | 変更のコミットとPR作成 |
