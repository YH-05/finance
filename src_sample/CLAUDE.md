# Quants/src - 開発・運用ガイドライン

## 0. 基本方針

-   **プロジェクト全体の方針**: `../../CLAUDE.md`を参照
-   **命令ファイルの同期**: `GEMINI.md` または `CLAUDE.md` のいずれかに変更を加えた場合、必ずもう一方のファイルにも同様の変更を反映させること。ただし、単なるコピーではなく、各エージェント（Claude/Gemini）の文脈に合わせた適切な内容に修正して記述すること。

### DVC運用

大容量データファイルはDVCで管理される。詳細は`../../CLAUDE.md`のGit/GitHub運用セクションを参照。

## 1. コード作成ガイドライン

今後の開発効率化とトークン節約のため、以下のガイドラインに従うこと。

### 1.1 Pythonコーディング規約

エンジニアに広く受け入れられている標準的な規約（PEP 8準拠）を採用する。

#### A. スタイルガイド (PEP 8)

-   **インデント**: スペース4つを使用する。
-   **命名規則**:
    -   変数・関数: `snake_case` (例: `get_weekly_return`)
    -   クラス: `CamelCase` (例: `WeeklyReportGenerator`)
    -   定数: `UPPER_CASE` (例: `TICKER_GROWTH`)
-   **行の長さ**: 1行は79文字以内を推奨するが、可読性を損なわない範囲で柔軟に対応する（最大120文字程度）。

#### B. 型ヒント (Type Hinting)

-   関数の引数と戻り値には型ヒントを付与する。
-   これにより、コードの意図が明確になり、AIによる解析や静的解析ツールの精度が向上する。

    ```python
    def calculate_return(price_series: pd.Series) -> float:
        ...
    ```

#### C. ドキュメンテーション (Docstrings)

-   すべてのモジュール、クラス、関数にDocstringを記述する。
-   Google Style または NumPy Style を推奨する。
-   **必須項目**:
    -   機能の概要
    -   引数（Parameters）の説明
    -   戻り値（Returns）の説明

### 1.2 データ取得ガイドライン

信頼性の高いデータ取得と、エラー発生時の堅牢性を確保するためのルール。

#### A. データソースの選定とID確認

-   **yfinance (Yahoo Finance)**:
    -   **用途**: 株価、ETF、為替レート。
    -   **ID確認**: ティッカーシンボル（例: `^SPX`, `AAPL`）は、必ずYahoo Financeのウェブサイト等で有効性を確認してからコードに実装する。不明な場合はWeb検索を行うこと。
    -   **注意**: `^SPX` (S&P 500) などの指数はデータ遅延や取得不可の場合があるため、必要に応じてETF（`SPY`, `IVV`等）をプロキシとして検討する。

-   **FRED (Federal Reserve Economic Data)**:
    -   **用途**: マクロ経済指標（金利、インフレ率、VIX等）。
    -   **ID確認**:
        -   原則として `Quants/data/FRED/fred_series.json` に記載されているシリーズIDを優先して使用する。
        -   もしデータが取得できない等のエラーが発生した場合、または新規に必要な指標がある場合は、FRED公式サイトで正しいシリーズIDを検索・確認し、`fred_series.json` に追加してから使用する。
    -   **注意**: 似たような系列（例: 月次 vs 日次、季節調整あり vs なし）があるため、目的に合致したIDを選定する。

#### B. エラーハンドリングとリトライ処理

-   **通信エラー対策**:
    -   `requests` や `yfinance` の呼び出し時は、必ず `try-except` ブロックで囲む。
    -   一時的なネットワークエラー（タイムアウト等）に備え、`tenacity` ライブラリ等を用いたリトライ処理（指数バックオフ）を実装することを推奨する。
-   **データ欠損対策**:
    -   取得したデータが空（Empty DataFrame）の場合や、必要なカラムが欠けている場合の分岐処理を記述する。
    -   `NaN` が含まれる場合、安易に `dropna()` せず、前日値での穴埋め（`ffill`）や、欠損率のログ出力を行う。

### 1.3 開発効率化・トラブルシューティング（Lessons Learned）

-   **Python環境の確認**:
    -   コード実行前に `sys.executable` を確認し、必要なライブラリ（pandas等）がインストールされた環境（Anaconda等）で実行されているか確認する。
-   **インポートパス（sys.path）の管理**:
    -   `src` ディレクトリ内のモジュール間インポートを行う場合、実行ディレクトリに依存しないよう、`sys.path.append` で適切なパスを追加する。

---

## 2. コード検証ガイドライン

プロフェッショナルな品質を担保するためのテスト・検証プロセス。

### 2.1 テスト手法

#### A. 単体テスト (Unit Testing)

-   **目的**: 個々の関数やメソッドが、意図した通りに動作することを確認する。
-   **ツール**: `pytest` または `unittest`。
-   **実装内容**:
    -   正常系: 期待される入力に対して、正しい出力が返るか。
    -   異常系: 不正な入力（None, 空リスト, 異常値）に対して、適切にエラーハンドリングされるか。
    -   境界値: 期間の境目やデータ数が少ない場合でも動作するか。

#### B. 統合テスト (Integration Testing)

-   **目的**: 複数のモジュール（例: データ取得→計算→レポート生成）が連携して正しく動作することを確認する。
-   **実行方法**: 実際にスクリプトをCLIから実行し、一連のフローが完走することを確認する（例: `python weekly_report_generator.py --action generate_draft`）。

### 2.2 数値の整合性検証（Cross-Check）

-   **主要指数・株価**:
    -   生成されたレポートの数値（SPX, Mag7など）を、Bloomberg Terminal または Yahoo Finance のウェブサイトで表示される数値とランダムに照合する。
    -   許容誤差: 数bps程度。方向性の不一致はNG。
-   **計算ロジック**:
    -   リターン計算期間（始点・終点）が正しいか確認する。

### 2.3 データの整合性チェック（Data Integrity）

-   **欠損値・外れ値**:
    -   `NaN` の有無、異常リターン（+/- 50%超）の有無をチェックする。

### 2.4 エラー時の対応フロー

1.  **ログ確認**: エラーメッセージとスタックトレースを確認。
2.  **データソース確認**: 外部サイトの稼働状況を確認。
3.  **手動実行**: ローカル環境で再現確認。
4.  **修正**: コード修正またはデータ補正。

---

## 3. ツール使用マニュアル: `weekly_report_generator.py`

このスクリプトは、AIエージェントが「ツール」として呼び出すことを想定して設計されている。

### 3.1 基本的な使い方

```bash
python src/weekly_report_generator.py --action [ACTION_NAME] [OPTIONS]
```

出力はすべて **JSON形式** で標準出力（stdout）に返される。

### 3.2 アクション一覧

#### `get_indices` / `get_mag7` / `get_sectors`

-   **共通仕様**: 以下の期間・指標についてリターンおよび効率性を計算して返す。
    -   **短期**: 前日比 (Daily), 先週比 (Weekly), 月初来 (MTD)
    -   **中期**: 年初来 (YTD), 1年 (1Y)
    -   **長期**: 3年 (3Y), 5年 (5Y)
    -   **効率性**: 1年以上の期間については、**効率性レシオ（年率平均リターン / 年率ボラティリティ）** も計算する。

-   **出力例**:

    ```json
    {
        "SPX": {
            "price": 4500.00,
            "returns": {
                "daily": 0.5,
                "weekly": 1.2,
                "mtd": 2.0,
                "ytd": 15.0,
                "1y": 20.0,
                "3y": 45.0,
                "5y": 80.0
            },
            "efficiency": {
                "1y": 1.5,
                "3y": 1.2,
                "5y": 1.1
            }
        },
        ...
    }
    ```

#### `get_macro`

-   **目的**: 金利、VIX、原油等のマクロ指標を取得する。

#### `generate_draft`

-   **目的**: 上記情報を統合し、Markdownレポートのドラフトを生成する。

### 3.3 AIエージェントへの指示

1.  **データ取得**: 各アクションを呼び出し、多角的な期間（短期〜長期）でパフォーマンスを分析する。
2.  **異常検知**: 短期的な急変動だけでなく、長期トレンドからの乖離や、効率性の変化にも注目する。
3.  **検索・執筆**: 分析結果に基づき、背景要因を検索しレポートを作成する。
