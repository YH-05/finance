# ライブラリ要求定義書 (Library Requirements Document)

## ライブラリ概要

### 名称
**market_analysis** - 金融市場データ取得・分析・可視化ライブラリ

### ライブラリの目的
- **市場データの統合取得**: yfinance と FRED API から株式・為替・債券・コモディティ・経済指標データを統一的に取得
- **テクニカル分析の提供**: 移動平均、ボラティリティ、相関分析等の基本指標を計算
- **分析結果の可視化・出力**: チャート生成と複数フォーマット（DataFrame, JSON, CSV, SQLite）でのエクスポート

### 解決する課題
金融市場データの取得・分析には、複数の API への対応、データ形式の統一、指標計算の実装が必要となる。
本ライブラリは、これらの処理を統一的な API で提供し、開発者がデータ分析ロジックに集中できるようにする。
また、AI エージェントからの利用を想定した構造化 JSON 出力により、自動化されたワークフローへの組み込みを容易にする。

### 提供する価値
- 複数データソース（yfinance, FRED）の統一的なアクセス
- グローバル市場（株式、為替、債券、コモディティ）の包括的なカバレッジ
- 分析に必要な基本指標の組み込み実装
- 柔軟な出力形式（DataFrame, JSON, CSV, SQLite, チャート画像）
- 日次バッチ処理・定期実行に対応した設計
- AI エージェント連携を考慮した構造化出力

## 想定利用者

### プライマリー利用者: Python 開発者・データアナリスト（経験 1 年以上）
- Python で金融データ分析を行う開発者
- pandas/numpy を日常的に使用
- 金融市場の基本的な知識を持つ
- 現在の課題: 複数データソースからのデータ取得が煩雑、分析コードの再利用性が低い
- 期待する解決策: 統一的な API で簡単にデータ取得・分析ができる
- 典型的な使用シナリオ: 日次で市場データを取得し、分析レポートを生成

### セカンダリー利用者: AI エージェント・自動化システム
- Claude Code 等の AI エージェントがプログラム経由で利用
- 構造化された JSON 形式でのデータ取得が必要
- 自動化されたワークフローの一部として組み込み
- 期待する解決策: 明確な JSON スキーマと予測可能な出力形式

## 成功指標

### 品質指標
- テストカバレッジ: 80% 以上
- 型カバレッジ: 100%（py.typed 対応、pyright strict モード）
- ドキュメントカバレッジ: 全公開 API に NumPy 形式 docstring

### パフォーマンス指標
- データ取得: 単一銘柄の 1 年分データ取得 5 秒以内
- 分析計算: 1000 データポイントの移動平均計算 100ms 以内
- チャート生成: 単一チャート生成 2 秒以内

### 信頼性指標
- API エラー時の明確なエラーメッセージとリトライ機能
- ネットワーク障害時のキャッシュフォールバック
- 全操作のログ出力

## 機能要件

### コア機能(MVI)

#### FR-001: 株価・指数データ取得

**使用例**:
Python 開発者として、市場分析のために、株価・指数の過去データを取得したい

**受け入れ条件**:
- [ ] yfinance を使用してティッカーシンボルでデータ取得できる
- [ ] 日付範囲を指定してデータを取得できる
- [ ] 取得データは pandas DataFrame 形式で返される
- [ ] OHLCV（始値、高値、安値、終値、出来高）データが含まれる
- [ ] 日本株（.T サフィックス）、米国株、主要指数に対応

**優先度**: P0(必須)

#### FR-002: 為替データ取得

**使用例**:
Python 開発者として、為替分析のために、通貨ペアの過去データを取得したい

**受け入れ条件**:
- [ ] 主要通貨ペア（USD/JPY, EUR/USD 等）のデータを取得できる
- [ ] yfinance の為替シンボル形式（USDJPY=X 等）に対応
- [ ] 日付範囲を指定してデータを取得できる

**優先度**: P0(必須)

#### FR-003: 経済指標データ取得（FRED API）

**使用例**:
Python 開発者として、マクロ分析のために、経済指標データを取得したい

**受け入れ条件**:
- [ ] FRED API から経済指標データを取得できる
- [ ] 主要指標（金利、GDP、CPI、失業率等）に対応
- [ ] 環境変数 `FRED_API_KEY` で API キーを設定
- [ ] 日付範囲を指定してデータを取得できる

**優先度**: P0(必須)

#### FR-004: コモディティデータ取得

**使用例**:
Python 開発者として、コモディティ分析のために、金・原油等のデータを取得したい

**受け入れ条件**:
- [ ] 金（GC=F）、原油（CL=F）等のコモディティデータを取得できる
- [ ] yfinance の先物シンボル形式に対応

**優先度**: P0(必須)

#### FR-005: 基本テクニカル指標計算

**使用例**:
Python 開発者として、テクニカル分析のために、移動平均等の指標を計算したい

**受け入れ条件**:
- [ ] 単純移動平均（SMA）を計算できる（期間指定可能）
- [ ] 指数移動平均（EMA）を計算できる（期間指定可能）
- [ ] 日次リターンを計算できる
- [ ] ボラティリティ（標準偏差ベース）を計算できる
- [ ] 計算結果は DataFrame の新しい列として追加される

**優先度**: P0(必須)

#### FR-006: 相関分析

**使用例**:
Python 開発者として、ポートフォリオ分析のために、複数銘柄間の相関を計算したい

**受け入れ条件**:
- [ ] 複数銘柄間の相関係数行列を計算できる
- [ ] ローリング相関を計算できる（期間指定可能）
- [ ] ベータ値（対ベンチマーク）を計算できる

**優先度**: P0(必須)

#### FR-007: チャート生成

**使用例**:
Python 開発者として、分析結果の可視化のために、チャートを生成したい

**受け入れ条件**:
- [ ] 価格チャート（ラインチャート）を生成できる
- [ ] 移動平均をオーバーレイできる
- [ ] 相関ヒートマップを生成できる
- [ ] PNG/SVG 形式でファイル出力できる
- [ ] plotly をメインのチャートライブラリとして使用
- [ ] marimo ノートブックでのインタラクティブ表示に対応
- [ ] plotly/marimo で対応できないチャートは matplotlib/seaborn を使用

**優先度**: P0(必須)

#### FR-008: データエクスポート

**使用例**:
Python 開発者として、データ連携のために、分析結果を複数形式で出力したい

**受け入れ条件**:
- [ ] pandas DataFrame 形式で取得できる（デフォルト）
- [ ] JSON 形式でエクスポートできる
- [ ] CSV 形式でエクスポートできる
- [ ] SQLite データベースに保存できる

**優先度**: P0(必須)

#### FR-009: AI エージェント向け JSON 出力

**使用例**:
AI エージェントとして、自動分析のために、構造化された JSON 形式でデータを取得したい

**受け入れ条件**:
- [ ] 明確な JSON スキーマでデータを出力できる
- [ ] メタデータ（取得日時、データソース、期間等）が含まれる
- [ ] エラー情報も構造化された形式で返される

**優先度**: P0(必須)

### APIインターフェース

```python
from market_analysis import MarketData, Analysis, Chart

# データ取得
data = MarketData()
stock_df = data.fetch_stock("AAPL", start="2024-01-01", end="2024-12-31")
fx_df = data.fetch_forex("USDJPY", start="2024-01-01")
econ_df = data.fetch_fred("DGS10")  # 10年国債金利
commodity_df = data.fetch_commodity("GC=F")  # 金

# 分析
analysis = Analysis(stock_df)
analysis.add_sma(period=20)
analysis.add_ema(period=50)
analysis.add_returns()
analysis.add_volatility(period=20)

# 相関分析
correlation = Analysis.correlation([stock1_df, stock2_df, stock3_df])
beta = Analysis.beta(stock_df, benchmark_df)

# チャート生成
chart = Chart(stock_df)
chart.price_chart(overlays=["SMA_20", "EMA_50"])
chart.save("chart.png")

# エクスポート
stock_df.to_json("data.json")
stock_df.to_csv("data.csv")
data.save_to_sqlite("market.db", stock_df, table_name="aapl")

# AI エージェント向け
json_output = data.to_agent_json(stock_df, include_metadata=True)
```

### 将来的な機能(Post-MVI)

#### FR-010: 高度なテクニカル指標

RSI、MACD、ボリンジャーバンド等の追加

**優先度**: P1(重要)

#### FR-011: 定期実行スケジューラ

日次バッチ処理の自動化機能

**優先度**: P1(重要)

#### FR-012: Markdown レポート生成

分析結果を note.com 向け Markdown 形式で出力

**優先度**: P2(できれば)

## 非機能要件

### パフォーマンス
- データ取得: 単一銘柄 1 年分のデータ取得 5 秒以内（ネットワーク状況に依存）
- 分析計算: 1000 データポイントの移動平均計算 100ms 以内
- チャート生成: 単一チャート 2 秒以内
- メモリ使用量: 10,000 データポイントの処理で 100MB 以内

### 互換性
- Python 3.12+ 対応
- 主要 OS（Linux, macOS, Windows）対応
- pyright strict モード対応
- pandas 2.0+ 対応

### 信頼性
- API エラー時: 明確なエラーメッセージと最大 3 回のリトライ
- キャッシュ: SQLite によるローカルキャッシュでオフライン時のフォールバック
- ログ: 全操作の構造化ログ出力（structlog 使用）

### テスト要件
- ユニットテスト: 全公開 API に対してテストを作成
- プロパティテスト: Hypothesis を使用した境界値テスト
- 統合テスト: 実際の API 呼び出しを含むテスト（CI ではモック化）
- テストカバレッジ: 80% 以上

### セキュリティ要件
- API キーは環境変数で管理（ハードコード禁止）
- 入力値のバリデーション（SQL インジェクション対策等）

## スコープ外

明示的にスコープ外とする項目:
- リアルタイムデータ取得（WebSocket 等）
- 有料 API（Bloomberg, Reuters 等）への対応
- バックテスト・シミュレーション機能
- 機械学習モデルの組み込み
- Web UI / ダッシュボード
- 取引執行機能
