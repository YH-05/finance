# ライブラリ要求定義書 (Library Requirements Document)

## ライブラリ概要

### 名称

**factor** - カスタムファクター開発フレームワーク

### ライブラリの目的

-   **ファクター定義の統一**: 設定ファイルと Python コードのハイブリッドアプローチで、シンプルなファクターも複雑なファクターも一貫した方法で定義
-   **統計的検証の自動化**: IC/IR、分位分析、回帰分析を統合し、ファクターの有効性を客観的に評価
-   **データソース抽象化**: 抽象インターフェースにより、yfinance/FRED から Factset/Bloomberg まで任意のデータソースに対応

### 解決する課題

ファクター投資の研究・開発において、ファクターの定義・計算・検証・バックテストは個別に実装されることが多く、
一貫性のない分析結果や再現性の問題が発生しやすい。
本ライブラリは、ファクター開発のライフサイクル全体を統合的に管理し、
データソースに依存しない汎用的なフレームワークを提供することで、
堅牢で再現可能なファクター研究を実現する。

### 提供する価値

-   **再現可能なファクター研究**: 設定ファイルベースのファクター定義により、研究結果の完全な再現が可能
-   **データソース非依存**: 抽象インターフェースにより、データプロバイダーを自由に切り替え可能
-   **包括的な検証機能**: IC/IR、分位分析、回帰分析を標準装備し、ファクターの有効性を多角的に評価
-   **strategy パッケージ連携**: 検証済みファクターを投資戦略にシームレスに統合

## 想定利用者

### プライマリー利用者: クオンツアナリスト / データサイエンティスト（経験 2 年以上）

-   Python でファクター投資の研究・開発を行う
-   pandas, numpy, scipy 等のデータ分析ライブラリに精通
-   型ヒントと静的解析ツールを活用する開発スタイル
-   現在の課題: ファクター定義・検証・バックテストが分散しており、一貫性のある研究が困難
-   期待する解決策: 統一されたフレームワークでファクター開発のライフサイクルを管理
-   典型的な使用シナリオ:
    1. 新しいファクター仮説を設定ファイルで定義
    2. 過去データでファクター値を計算
    3. IC/IR、分位分析で有効性を検証
    4. バックテストでパフォーマンスを確認
    5. 有望なファクターを strategy パッケージへ連携

### セカンダリー利用者: 個人投資家 / 投資教育者（経験 1 年以上）

-   Python の基本を理解し、投資分析に活用
-   既存のファクター（モメンタム、バリュー等）を使用
-   現在の課題: ファクター投資の理論は理解しているが、実装方法がわからない
-   期待する解決策: ビルトインファクターと明確なドキュメントで学習しながら使用可能

## 成功指標

### 品質指標

-   テストカバレッジ: 80%以上
-   型カバレッジ: 100%（py.typed 対応）
-   ドキュメントカバレッジ: 全公開 API に NumPy 形式の docstring

### パフォーマンス指標

-   ファクター計算: 100 銘柄 × 5 年日次データで 1 秒以内
-   メモリ効率: 入力データの 3 倍以内のメモリ使用量
-   バックテスト: 1000 営業日のシミュレーションで 5 秒以内

### 利用者指標

-   新規利用者が 10 分以内にビルトインファクターでバックテストを実行可能（サンプルコード参照）
-   カスタムファクターの定義から検証まで 30 分以内で完了可能

## 機能要件

### コア機能(MVI)

#### 1. DataProvider インターフェース

**使用例**:
クオンツアナリストとして、任意のデータソースを統一的に扱うために、抽象化されたデータ取得インターフェースが欲しい

**受け入れ条件**:

-   [ ] DataProvider プロトコルが定義されている
-   [ ] 価格データ（OHLCV）の取得メソッドが定義されている
-   [ ] 財務データ（PER, PBR 等）の取得メソッドが定義されている
-   [ ] 複数銘柄の一括取得が可能
-   [ ] 日付範囲を指定した取得が可能
-   [ ] yfinance アダプターが実装されている

**優先度**: P0(必須)

#### 2. Factor 基底クラス

**使用例**:
クオンツアナリストとして、カスタムファクターを簡単に定義するために、継承可能な基底クラスが欲しい

**受け入れ条件**:

-   [ ] Factor プロトコル/基底クラスが定義されている
-   [ ] ファクター名、説明、パラメータを属性として持つ
-   [ ] compute() メソッドでファクター値を計算
-   [ ] 戻り値は pandas DataFrame（銘柄 × 日付）
-   [ ] 欠損値処理のオプションが利用可能

**優先度**: P0(必須)

#### 3. ファクター正規化

**使用例**:
クオンツアナリストとして、ファクター値を比較可能にするために、標準的な正規化手法が欲しい

**受け入れ条件**:

-   [ ] クロスセクショナル z-score 正規化が実装されている
-   [ ] ランク正規化（パーセンタイル）が実装されている
-   [ ] 外れ値処理（Winsorization）が利用可能
-   [ ] ユニバース内での正規化が可能

**優先度**: P0(必須)

#### 4. IC/IR 計算

**使用例**:
クオンツアナリストとして、ファクターの予測力を評価するために、IC（情報係数）と IR（情報比率）が欲しい

**受け入れ条件**:

-   [ ] Spearman IC（ランク相関）が計算できる
-   [ ] Pearson IC（線形相関）が計算できる
-   [ ] IR（IC の平均 / 標準偏差）が計算できる
-   [ ] 時系列での IC 推移を取得できる
-   [ ] 統計的有意性（t 値、p 値）が出力される

**優先度**: P0(必須)

#### 5. 分位分析

**使用例**:
クオンツアナリストとして、ファクターの単調性を確認するために、分位別リターン分析が欲しい

**受け入れ条件**:

-   [ ] 任意の分位数（デフォルト 5 分位）でポートフォリオを構築
-   [ ] 各分位の平均リターンを計算
-   [ ] Long-Short リターン（Top - Bottom）を計算
-   [ ] 分位別リターンの可視化が可能

**優先度**: P0(必須)

#### 6. ビルトインファクター（価格ベース）

**使用例**:
個人投資家として、すぐに使えるファクターが欲しいので、一般的なファクターがビルトインされていてほしい

**受け入れ条件**:

-   [ ] モメンタム（1 ヶ月、3 ヶ月、12 ヶ月リターン）が実装されている
-   [ ] リバーサル（短期リターンの反転）が実装されている
-   [ ] ボラティリティ（標準偏差ベース）が実装されている
-   [ ] 各ファクターにドキュメントとサンプルコードがある

**優先度**: P0(必須)

#### 7. ビルトインファクター（バリュー）

**使用例**:
クオンツアナリストとして、割安株を特定するために、バリューファクターが欲しい

**受け入れ条件**:

-   [ ] PER（株価収益率）ファクターが実装されている
-   [ ] PBR（株価純資産倍率）ファクターが実装されている
-   [ ] 配当利回りファクターが実装されている
-   [ ] EV/EBITDA ファクターが実装されている（データ利用可能時）
-   [ ] 複合バリューファクター（複数指標の組み合わせ）が実装されている

**優先度**: P0(必須)

#### 8. ビルトインファクター（クオリティ）

**使用例**:
クオンツアナリストとして、高品質な企業を特定するために、クオリティファクターが欲しい

**受け入れ条件**:

-   [ ] ROE（自己資本利益率）ファクターが実装されている
-   [ ] ROA（総資産利益率）ファクターが実装されている
-   [ ] 利益の安定性（収益のボラティリティ）ファクターが実装されている
-   [ ] 負債比率ファクターが実装されている
-   [ ] 複合クオリティファクター（複数指標の組み合わせ）が実装されている

**優先度**: P0(必須)

#### 9. ビルトインファクター（サイズ）

**使用例**:
クオンツアナリストとして、企業規模に基づいた分析を行うために、サイズファクターが欲しい

**受け入れ条件**:

-   [ ] 時価総額ファクターが実装されている
-   [ ] 売上高ファクターが実装されている（データ利用可能時）
-   [ ] 総資産ファクターが実装されている（データ利用可能時）
-   [ ] サイズファクターの符号反転オプション（小型株プレミアム）が利用可能

**優先度**: P0(必須)

#### 10. ファクターカテゴリ拡張フレームワーク

**使用例**:
クオンツアナリストとして、将来的に様々なデータソースからファクターを構築したいので、拡張可能なフレームワークが欲しい

**受け入れ条件**:

-   [ ] ファクターカテゴリ（価格ベース、ファンダメンタル、マクロ、オルタナティブ）の分類が定義されている
-   [ ] 各カテゴリに対応する DataProvider インターフェースの拡張ポイントが用意されている
-   [ ] 新しいファクターカテゴリを追加するためのドキュメントがある
-   [ ] ファクターのメタデータ（必要なデータ種別、計算頻度等）が定義できる

**優先度**: P0(必須)

### API インターフェース

```python
# 基本的な使用例
from factor import MomentumFactor, ValueFactor, QualityFactor, SizeFactor
from factor.providers import YFinanceProvider
from factor.validation import ICAnalyzer, QuantileAnalyzer

# データプロバイダーの設定
provider = YFinanceProvider()

# ユニバースの定義
universe = ["AAPL", "GOOGL", "MSFT", "AMZN", "META", "NVDA"]

# 価格ベースファクター
momentum = MomentumFactor(lookback=252)  # 12ヶ月モメンタム
momentum_values = momentum.compute(
    provider=provider,
    universe=universe,
    start_date="2020-01-01",
    end_date="2024-01-01",
)

# バリューファクター
value = ValueFactor(metric="per")  # PER ベース
value_values = value.compute(
    provider=provider,
    universe=universe,
    start_date="2020-01-01",
    end_date="2024-01-01",
)

# クオリティファクター
quality = QualityFactor(metric="roe")  # ROE ベース
quality_values = quality.compute(
    provider=provider,
    universe=universe,
    start_date="2020-01-01",
    end_date="2024-01-01",
)

# サイズファクター
size = SizeFactor(invert=True)  # 小型株プレミアム（符号反転）
size_values = size.compute(
    provider=provider,
    universe=universe,
    start_date="2020-01-01",
    end_date="2024-01-01",
)

# ファクター検証
ic_analyzer = ICAnalyzer()
ic_result = ic_analyzer.analyze(momentum_values, forward_returns)
print(f"Mean IC: {ic_result.mean_ic:.4f}, IR: {ic_result.ir:.4f}")

quantile_analyzer = QuantileAnalyzer(n_quantiles=5)
quantile_result = quantile_analyzer.analyze(momentum_values, forward_returns)
quantile_result.plot()
```

```python
# カスタムファクターの定義
from factor import Factor
import pandas as pd

class MyCustomFactor(Factor):
    """カスタムファクターの例: 価格モメンタム + ボリューム"""

    name = "price_volume_momentum"
    description = "価格変化率とボリューム変化率の複合ファクター"

    def __init__(self, price_lookback: int = 20, volume_lookback: int = 20):
        self.price_lookback = price_lookback
        self.volume_lookback = volume_lookback

    def compute(self, provider, universe, start_date, end_date) -> pd.DataFrame:
        prices = provider.get_prices(universe, start_date, end_date)
        volumes = provider.get_volumes(universe, start_date, end_date)

        price_mom = prices.pct_change(self.price_lookback)
        volume_mom = volumes.pct_change(self.volume_lookback)

        return price_mom * volume_mom
```

```yaml
# 設定ファイルベースのファクター定義 (factor_config.yaml)
factors:
    - name: momentum_12m
      type: builtin.momentum
      params:
          lookback: 252 # 12ヶ月（営業日）

    - name: volatility_20d
      type: builtin.volatility
      params:
          lookback: 20

    - name: custom_combined
      type: expression
      formula: "momentum_12m * -volatility_20d"
      description: "低ボラティリティ・高モメンタム"
```

### 将来的な機能(Post-MVI)

#### 11. 回帰分析

ファクターエクスポージャーとリターンの回帰分析。Fama-MacBeth 回帰、パネル回帰をサポート。

**優先度**: P1(重要)

#### 12. バックテストエンジン

ファクターベースのポートフォリオ構築とパフォーマンス評価。リバランス、コスト考慮を含む。

**優先度**: P1(重要)

#### 13. レポート生成

分析結果の Markdown/PDF レポート自動生成。チャート、テーブル、サマリーを含む。

**優先度**: P1(重要)

#### 14. strategy パッケージ連携

strategy パッケージへのシグナル出力インターフェース。

**優先度**: P1(重要)

#### 15. FRED アダプター / マクロ経済ファクター

マクロ経済指標を含むファクター構築のための FRED データプロバイダー。
金利、インフレ率、GDP 成長率等のマクロファクターを構築可能に。

**優先度**: P2(できれば)

#### 16. ファンダメンタルデータプロバイダー

財務諸表データ（損益計算書、貸借対照表、キャッシュフロー計算書）の取得インターフェース。
Factset、Bloomberg、Refinitiv 等の商用データソースへの対応。

**優先度**: P2(できれば)

#### 17. オルタナティブデータファクター

ニュースセンチメント、SNS データ、衛星画像等のオルタナティブデータに基づくファクター。
外部 API との連携インターフェースを提供。

**優先度**: P2(できれば)

#### 18. 並列処理

大規模ユニバースでのファクター計算の並列化。

**優先度**: P2(できれば)

#### 19. ファクター合成・組み合わせ

複数ファクターの線形結合、非線形結合による合成ファクターの構築。
ファクター間の相関を考慮した最適な組み合わせ方法の提案機能。

**優先度**: P2(できれば)

## 非機能要件

### パフォーマンス

-   ファクター計算: 100 銘柄 × 5 年日次データ（約 125,000 データポイント）で 1 秒以内
-   IC 計算: 100 銘柄 × 1000 日のデータで 500ms 以内
-   メモリ使用量: 入力データの 3 倍以内

### 互換性

-   Python 3.12+ 対応
-   主要な型チェッカー（pyright）対応
-   pandas 2.0+ 対応
-   numpy 1.26+ 対応

### 信頼性

-   全公開 API のテストカバレッジ: 80%以上
-   エラー発生時の明確なメッセージ（期待値と実際値を含む）
-   入力データの検証（型、範囲、欠損値）

### テスト要件

-   ユニットテスト: 各関数/メソッドの個別テスト
-   プロパティテスト: Hypothesis によるエッジケース検証
-   統合テスト: 実データを使用したエンドツーエンドテスト
-   回帰テスト: 既知のファクター値との比較

## スコープ外

明示的にスコープ外とする項目:

-   **リアルタイムデータ処理**: 本ライブラリは日次以上の頻度を対象とし、ティック・分足データは対象外
-   **執行システム連携**: 実際の取引執行は strategy パッケージの責務
-   **独自データベース**: データの永続化は呼び出し側の責務（キャッシュは提供）
-   **機械学習モデル**: ML ベースのファクターは別パッケージで対応
-   **ファンダメンタルデータの計算**: PER, PBR 等はデータソースから取得を想定
