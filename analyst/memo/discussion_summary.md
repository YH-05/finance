# 設計議論サマリー — Phase 0 〜 Dify実装設計

> 作成日: 2026-02-13
> 対象文書: [CAGR推定フレームワーク](cagr_estimation_framework.md) → [Phase 0 設計メモ](phase0_philosophy_injection_design.md) → [Phase 0 議論ログ](phase0_discussion_log.md) → [Dify設計議論](dify_design_discussion.md)

---

## 文書階層と議論の流れ

```
cagr_estimation_framework.md     ← 全体設計（Phase 0〜5）
  └── phase0_philosophy_injection_design.md  ← Phase 0 設計メモ（12ルール、パターン、アーキテクチャ）
        └── phase0_discussion_log.md         ← Phase 0 設計議論（9議論、すべて解決済）
              └── dify_design_discussion.md  ← Dify実装設計議論（13判断、すべて確定済）
                    └── dify_workflow_design.md  ← Dify詳細設計書（本議論の成果物）
```

---

## Phase 0 設計議論（9議論）

### 確立された原則

| # | 原則 | 源泉 |
|---|------|------|
| P1 | **ルール体系の範囲 = KYの暗黙知の表出のみ。** 分析者として「あるべき」ルールを追加しない | 議論1 |
| P2 | **ルール追加基準**: 既存ルールの補足で吸収できるものは補足に留める。新たな判断軸が出たときのみ新規ルール | 議論9 |
| P3 | **品質の目的**: チェックリスト的な排除ではなく、KYの思考プロセスの再現 | 議論6 |

### 議論と結論一覧

| # | 議題 | 結論 |
|---|------|------|
| 1 | 12ルールの過不足 | 現行12ルールで確定。過不足の基準 =「KYの31件の評価を再現できるか」 |
| 2 | ルールの優先順位 | 全12ルール同時投入。段階的投入は不採用（横比較が非現実的） |
| 3 | ブランド力4類型の扱い | ルール1の補足として常時注入（独立ルール化はしない） |
| 4 | アーキテクチャ | ハイブリッド構成（ゲートキーパー＝常時注入、残り＝RAG/ナレッジ） |
| 5 | PoC対象銘柄 | 新規銘柄（アウトオブサンプル）。他アナリスト執筆済みレポートから選定 |
| 6 | 品質差の測定方法 | 方式C（テキストフィードバック定性評価）。却下/高評価パターンの出現で構造化 |
| 7 | REASONING段階の安定化 | 4ステップワークフロー（主張抽出→構造化出力→ファクトチェック→検証エージェント） |
| 8 | フィードバック設計 | 静的テンプレート（納得度＋条件別質問1文＋任意補足）。全体評価欄をレポート末尾に |
| 9 | 確度のCAGRパラメータ統合 | ルール5の補足として注入（寄与幅と達成確度を統合。CHD方式） |

---

## Dify実装設計議論（13判断）

### 新たに確立された原則

| # | 原則 | 源泉 |
|---|------|------|
| P4 | **分類体系はフィードバックループの「出力」であり、外部から注入する「入力」ではない。** Seven Powersなどの外部フレームワークを分類軸として導入しない | 議論A-1 |
| P5 | **ファクトチェックで検証不可・矛盾が判明しても、主張は破棄しない。** KYの判断軸拡充が最優先事項。フィードバックループを完成させるため、すべての主張をアノテーション付きでKYに提示 | 議論A-4 |
| P6 | **RAG依存 + 一覧表による緩和。** 将来のルール拡張（テキスト量増大）に備え、詳細はRAGに委ね、システムプロンプトにはルール定義のみ（目次）を配置 | 議論B-1 |

### 判断と結論一覧

#### 論点A: KYの投資哲学をどのように「素材」として用意するか

| # | 判断事項 | 結論 |
|---|---------|------|
| 1 | チャンク粒度 | **1チャンクにまとめる**（ルール＋具体例を分離しない） |
| 2 | few-shot例の構造化 | **銘柄単位**（主張単位ではない） |
| 3 | ナレッジベース分割 | **機能別に3分割**（KB1:ルール集, KB2:パターン集, KB3:few-shot集） |
| 10 | 分類フレームワーク | **descriptive_labelで開始**。KYの固有分類軸はフィードバック蓄積後に導入 |
| 11 | claim_typeの種別 | **3種別**: `competitive_advantage`, `cagr_connection`, `factual_claim` |
| 12 | ファクトチェック失敗時 | **アノテーションのみ（破棄しない）** |
| 8 | ステップ間データ形式 | **構造化JSON** |

#### 論点B: 知識検索ノードの使い方

| # | 判断事項 | 結論 |
|---|---------|------|
| 4 | 検索クエリ設計 | **主張テキストを直接使用**（LLMクエリ生成は不要） |
| 5 | Top-K | **ステップ2: 5件（KB1+KB3, 13チャンク中）/ ステップ4: 4件（KB2, 12チャンク中）** |
| 6 | 常時取得 vs 動的取得 | **RAG依存 + 一覧表による緩和**。12ルール定義のみ（~200トークン）をシステムプロンプトに目次配置 |

#### 論点C: Difyワークフロー全体設計

| # | 判断事項 | 結論 |
|---|---------|------|
| 7 | ワークフロー分割 | **単一ワークフロー**。DifyのLLMノードは独立API呼び出しで文脈残留なし |
| 9 | 入力方式 | **レポート: ファイルアップロード / 10-K: KB4（銘柄ごとのナレッジベース）** |
| 13 | レポート生成・検証 | **ステップ5（レポート生成）+ ステップ6（KB1+KB2参照の3層検証）を追加** |

---

## 議論中のユーザー介入と軌道修正

議論中にユーザー（設計者）が重要な介入を行い、設計方針を軌道修正した箇所:

### 1. 分類フレームワークの否定（判断10）

**AI提案**: Seven Powersなどの市場標準フレームワークで主張を分類
**ユーザー介入**: 「KYの競争優位性観点をフィードバックループで拡充していくことが目的であるのならば、外部フレームワークを注入するとKYがアンカリングされる」
**結果**: descriptive_labelで開始し、分類体系をフィードバックの「出力」として位置づけ

### 2. ワークフロー分割の否定（判断7）

**AI提案**: 生成と検証を別ワークフローに分離（文脈汚染防止のため）
**ユーザー介入**: 「DifyではLLMノードは独立API呼び出しで文脈は残らない。ワークフローはまだ複雑ではない」
**結果**: 単一ワークフローを採用

### 3. RAGスケーラビリティへの指摘（判断6）

**AI提案**: 全ルール常時注入（~3,500トークン）
**ユーザー介入**: 「今後優位性の定義のテキスト量が増大することを踏まえると？」
**結果**: RAG依存 + 一覧表緩和に変更

### 4. レポート検証の追加要求（判断13）

**ユーザー介入**: 「AIが最初のレポートを作成した後、そのレポートを別のAIがチェックする仕組みは組み込まれているか？」+ 「JSONとの整合だけでなく、KYのナレッジベースとの整合性チェックも追加したい」
**結果**: ステップ5（レポート生成）+ ステップ6（3層検証: JSON整合＋ルール整合＋パターン整合）を追加

---

## KYの分類軸が浮かび上がるプロセス

```
PoC v1: 分類軸なし（descriptive_labelのみ）
  ↓
KYのフィードバック蓄積（5〜10銘柄分）
  ↓
分析: KYが高評価/低評価した主張を横断的に見る
  ↓
パターン発見 → KY固有の分類軸を仮説化
  ↓
KYに確認 → 分類軸として確定
  ↓
PoC v2: KY固有の分類軸を導入
```

先行例: ブランド力4類型（Phase 0 議論3）は、KYのフィードバックから自然発生的に浮かび上がった分類軸の萌芽。

---

## 確定した成果物

| 成果物 | 説明 | ファイル |
|--------|------|---------|
| 12ルール + 2補足 | KYの投資判断ルール体系 | `phase0_philosophy_injection_design.md` セクション2, 8.1 |
| 却下パターン A〜G | 低評価の構造化パターン | 同 セクション3 |
| 高評価パターン I〜V | 高評価の構造化パターン | 同 セクション4 |
| フィードバックテンプレート | KYからフィードバックを引き出す仕組み | 同 セクション8.4 |
| 改善サイクル設計 | Phase 0 → Phase 1 → Phase 2 → ルール精緻化のループ | 同 セクション8.4 |
| 構造化JSON出力スキーマ | claims配列の3種別（competitive_advantage, cagr_connection, factual_claim） | `dify_design_discussion.md` 議論A-3 |
| Difyワークフロー設計 | 10ノード（LLM×6 + 知識検索×4）、4ナレッジベース | `dify_workflow_design.md` |

---

## 未解決事項・次のアクション

| # | 項目 | ステータス | 次のアクション |
|---|------|-----------|---------------|
| 1 | PoC対象銘柄の最終決定 | 方針決定済（アウトオブサンプル） | 他アナリストレポートから具体的銘柄を選定 |
| 2 | KB1〜KB3のチャンクテキスト作成 | 設計確定済 | 12ルール+具体例のテキストを実際に書き起こし |
| 3 | KB4（10-K/10-Q）の準備 | 設計確定済 | PoC銘柄の10-Kをチャンク分割してKB4に投入 |
| 4 | Difyワークフローの構築 | 詳細設計確定済 | `dify_workflow_design.md` に基づきDifyで実装 |
| 5 | 各ステップのシステムプロンプト詳細 | 構成確定済 | 実際のプロンプト文面を作成 |
| 6 | PoC v1の実行と評価 | — | ワークフロー構築後、PoC銘柄で実行しKYに評価依頼 |

---

## 関連ファイル

| ファイル | 説明 |
|---------|------|
| `analyst/memo/cagr_estimation_framework.md` | CAGR推定フレームワーク全体設計 |
| `analyst/memo/phase0_philosophy_injection_design.md` | Phase 0 設計メモ（確定版） |
| `analyst/memo/phase0_discussion_log.md` | Phase 0 設計議論ログ（9議論） |
| `analyst/memo/dify_design_discussion.md` | Dify設計議論ログ（13判断） |
| `analyst/memo/dify_workflow_design.md` | Difyワークフロー詳細設計書 |
| `analyst/Competitive_Advantage/analyst_YK/judgment_patterns.md` | KYの判断パターン横断分析 |
| `analyst/Competitive_Advantage/analyst_YK/feedback.md` | KYのフィードバックスレッド |
