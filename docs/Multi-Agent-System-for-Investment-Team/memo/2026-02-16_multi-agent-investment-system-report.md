## Claude Codeを用いたマルチエージェント型海外株式投資システム構築レポート

### 1. 結論と内容の全体像

本レポートでは、Claude Codeを活用してプロフェッショナルな海外株式投資チームを仮想的に編成し、運用・評価するための包括的なフレームワークを提案します。

**結論として、LLM（大規模言語モデル）を用いたマルチエージェントシステム（MAS）は、従来のクオンツ手法や単一エージェントよりも、非構造化データ（ニュース、レポート）と構造化データ（財務指標、株価）を高度に統合した意思決定が可能です。**

本レポートの構成は以下の通りです：

1. **エージェントチーム構成**: 役割（アナリスト、リスク管理、トレーダー）を分散させ、議論を通じて意思決定の質を高める設計。
2. **ポートフォリオ構築**: アルファファクターの自動生成から、リスク許容度に応じた動的なウェイト最適化手法。
3. **パフォーマンス測定とバイアス対策**: 「先読みバイアス（Look-ahead bias）」や「データ汚染（Contamination）」を排除し、真の運用能力を測定するための厳格なバックテスト手法。

---

### 2. マルチエージェント・チーム構成の設計

海外株式市場の複雑性に対応するため、役割を細分化したエージェントを Claude Code 上でオーケストレートします。

#### 2.1 専門役割の定義

先行研究（_TradingAgents_, _AlphaAgents_）に基づき、以下の役割を編成します。

- **ファンダメンタル・アナリスト (Fundamental Analyst)**
- **役割**: 財務諸表（損益計算書、貸借対照表、キャッシュフロー計算書）を解析し、企業の収益性、健全性、成長性を評価する。
- **ソース**: _TradingAgents: Multi-Agents LLM Financial Trading Framework_

- **センチメント・アナリスト (Sentiment Analyst)**
- **役割**: 金融ニュース、SNS、プレスリリースを解析し、市場の心理的側面や短期的なセンチメントスコアを算出する。
- **ソース**: _StockBench: Can LLM Agents Trade Stocks Profitably In Real-world Markets?_

- **テクニカル・アナリスト (Technical Analyst)**
- **役割**: 移動平均、RSI、MACDなどのテクニカル指標を計算・解釈し、トレンドの転換点や過熱感を特定する。

- **マクロ・レジーム・アナリスト (Bull/Bear Researchers)**
- **役割**: 金利動向、為替（FX）、地政学的リスクを監視し、現在の市場が「強気」か「弱気」かを判定する。
- **ソース**: _TradingAgents_

- **リスクマネージャー (Risk Manager)**
- **役割**: ポートフォリオ全体の露出（エクスポージャー）を管理し、最大ドローダウンの抑制やセクター間の分散を強制する。
- **ソース**: _HedgeAgents: A Balanced-aware Multi-agent Financial Trading System_

- **リード・トレーダー / ファンドマネージャー (Lead Trader)**
- **役割**: 各アナリストの提案を統合し、最終的な売買注文（Buy/Sell/Hold）と取引量を決定する。

#### 2.2 協調プロトコル (Communication Logic)

エージェント間の「議論（Debate）」プロセスを導入することで、単一モデルのハルシネーション（誤情報）を抑制します。

- **Financial Chain-of-Thought (CoT)**: 複雑な金融問題を論理的なステップに分解して思考させる。
- **階層的メモリ検索 (Hierarchical Memory Retrieval)**: 過去の投資判断とその結果をメモリとして保持し、類似の市場状況下での教訓を現在に活かす。
- **ソース**: _FinRobot: An Open-Source AI Agent Platform for Financial Applications using Large Language Models_, _HedgeAgents_

---

### 3. ポートフォリオ構築の方法論

単なる銘柄選択にとどまらず、計量的手法とLLMの判断を組み合わせた最適化を行います。

#### 3.1 アルファファクターの自動生成

LLMを用いて、数千もの候補から有効な「アルファファクター（超過収益の源泉）」を自動生成します。

- **プロセス**: LLMにPythonコードを出力させ、過去のデータで有効性を検証。予測能力の高いファクターのみを採用する。
- **手法**: リスク認識型マルチエージェントによる評価（Predictive Quality, Category Balance）。
- **ソース**: _Automate Strategy Finding with LLM in Quant Investment_

#### 3.2 動的ウェイト最適化と選択

- **Top-k / Drop-n セレクション**: 全銘柄をアルファ値でランク付けし、上位k銘柄を採用。入れ替え（ターンオーバー）コストを抑えるため、一定の閾値を下回るまで保持し続ける。
- **等金額リバランス vs 最適化リバランス**: シンプルな等金額配分（Equal-weight）は分散効果が高いが、ボラティリティ調整（Risk-parity）を組み合わせることでシャープレシオを向上させる。
- **週次・月次リバランス**: MASFINモデルに基づき、週次でポートフォリオを再構築し、短期的な市場の変化に対応する。
- **ソース**: _MASFIN: A Multi-Agent System for Decomposed Financial Reasoning and Forecasting_

---

### 4. 先読みバイアスとパフォーマンス測定

LLMを用いた投資戦略において最大の落とし穴は、モデルが「未来の知識」を学習してしまっていること、あるいはバックテスト時に「未来の情報」を参照してしまう「先読みバイアス」です。

#### 4.1 先読みバイアス (Look-ahead Bias) の排除

LLMは訓練データとして過去の株価を知っている可能性があるため、以下の対策を講じます。

1. **時間的隔離 (Temporal Isolation)**: バックテストの各時点において、その日以前のニュースやデータのみをプロンプトに含める。
2. **デバイアス処理 (De-biasing)**: ニュースの見出しから「結果」を示唆する単語（例：「株価急騰後の...」）を、LLMを用いて中立的な表現に書き換えてから分析させる。
3. **ソース**: _Assessing Look-Ahead Bias in Stock Return Predictions Generated By GPT Sentiment Analysis_

#### 4.2 データ汚染 (Contamination) への対応

LLMのトレーニングカットオフ日以降のデータで検証を行うか、モデルがその期間の結果を知っているかを確認する「汚染チェック」を導入します。

- **StockBench手法**: 特定の期間の株価推移をLLMが言い当てられるかテストし、正解率が高い期間は評価から除外する。
- **ソース**: _StockBench_

#### 4.3 堅牢な評価指標 (Robust Metrics)

単なる累積リターンだけでなく、以下の指標を用いて「実務に耐えうるか」を判定します。

- **シャープレシオ (Sharpe Ratio) / ソルティノレシオ (Sortino Ratio)**: リスクに対するリターンの効率性。
- **最大ドローダウン (Maximum Drawdown)**: 下落局面での耐性。
- **市場レジーム分析**: 強気相場（Bull）で過度に保守的でないか、弱気相場（Bear）で過度に攻撃的でないかを、パッシブなインデックス（S&P 500等）と比較評価する。
- **ソース**: _Can LLM-based Financial Investing Strategies Outperform the Market in Long Run?_

---

### 5. Claude Code による実装ステップ

Claude Code 環境でこのシステムを運用するための具体的なアクションプランです。

1. **環境構築**: Python環境を整備し、`yfinance` などのAPIを用いて海外株式（米国株等）のヒストリカルデータを取得するツールを Claude Code に作成させます。
2. **エージェントのスクリプト化**: 各役割（アナリスト等）に対応する個別のシステムプロンプトを作成し、`n8n` や Python の非同期処理でこれらを連携させます。
3. **バックテストエンジンの構築**:

- `FINSABER` フレームワークを参考に、長期（5〜10年）かつ広範な銘柄（100銘柄以上）でのバックテストを実行します。
- **ソース**: _Can LLM-based Financial Investing Strategies Outperform the Market in Long Run?_

4. **モニタリングと自己反省 (Reflection)**: エージェントに自身の過去のトレード失敗を分析させ、プロンプトや戦略を自動修正（Self-Correction）するループを組み込みます。

---

### 6. まとめ

Claude Codeを用いたマルチエージェント投資システムは、高度な理論の実装と迅速なプロトタイピングを可能にします。本レポートで提案した「役割分散型チーム」「厳格なバイアス除去」「動的なポートフォリオ最適化」を組み合わせることで、個人の副業レベルを超えた、機関投資家レベルに近い戦略構築が期待できます。

今後は、市場の急変時に自動で「ヘッジエージェント」が稼働するような、より強固なリスク管理モジュールの強化が鍵となります。

---

**参照ソース一覧**:

- _StockBench: Can LLM Agents Trade Stocks Profitably In Real-world Markets?_ (Tsinghua Univ.)
- _AlphaAgents: Large Language Model based Multi-Agents for Equity Portfolio Constructions_ (BlackRock)
- _Can LLM-based Financial Investing Strategies Outperform the Market in Long Run?_ (Univ. of Edinburgh)
- _HedgeAgents: A Balanced-aware Multi-agent Financial Trading System_ (South China Univ. of Tech)
- _Automate Strategy Finding with LLM in Quant Investment_ (HKUST)
- _MASFIN: A Multi-Agent System for Decomposed Financial Reasoning and Forecasting_ (Rochester Inst. of Tech)
- _TradingAgents: Multi-Agents LLM Financial Trading Framework_ (UCLA/MIT)
- _FinRobot: An Open-Source AI Agent Platform for Financial Applications using Large Language Models_ (AI4Finance Foundation)
- _Assessing Look-Ahead Bias in Stock Return Predictions Generated By GPT Sentiment Analysis_ (Glasserman et al.)
